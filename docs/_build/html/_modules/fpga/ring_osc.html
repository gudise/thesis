<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>fpga.ring_osc &#8212; thesis  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/classic.css?v=514cf933" />
    
    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">thesis  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../fpga.html" accesskey="U">fpga</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">fpga.ring_osc</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for fpga.ring_osc</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Este módulo contiene una serie de clases y funciones para implementar y</span>
<span class="sd">medir una matriz de osciladores de anillo en FPGA, tanto estándar como</span>
<span class="sd">de Galois.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span> <span class="k">as</span> <span class="nn">_os</span>
<span class="kn">from</span> <span class="nn">shutil</span>                 <span class="kn">import</span>  <span class="n">copy</span>        <span class="k">as</span> <span class="n">_copy</span>
<span class="kn">from</span> <span class="nn">pickle</span>                 <span class="kn">import</span>  <span class="n">dump</span>        <span class="k">as</span> <span class="n">_dump</span><span class="p">,</span>\
                                    <span class="n">load</span>        <span class="k">as</span> <span class="n">_load</span>
<span class="kn">from</span> <span class="nn">serial</span>                 <span class="kn">import</span>  <span class="n">Serial</span>      <span class="k">as</span> <span class="n">_Serial</span>
<span class="kn">from</span> <span class="nn">time</span>                   <span class="kn">import</span>  <span class="n">sleep</span>       <span class="k">as</span> <span class="n">_sleep</span>
<span class="kn">from</span> <span class="nn">numpy</span>                  <span class="kn">import</span>  <span class="n">reshape</span>     <span class="k">as</span> <span class="n">_reshape</span><span class="p">,</span>\
                                    <span class="n">log2</span>        <span class="k">as</span> <span class="n">_log2</span><span class="p">,</span>\
                                    <span class="n">transpose</span>   <span class="k">as</span> <span class="n">_transpose</span><span class="p">,</span>\
                                    <span class="n">inf</span>         <span class="k">as</span> <span class="n">_inf</span>
<span class="kn">from</span> <span class="nn">numpy.random</span>           <span class="kn">import</span>  <span class="n">normal</span>      <span class="k">as</span> <span class="n">_normal</span>
<span class="kn">from</span> <span class="nn">myutils</span>                <span class="kn">import</span>  <span class="o">*</span>
<span class="kn">from</span> <span class="nn">myfpga</span>                 <span class="kn">import</span>  <span class="o">*</span>
<span class="kn">from</span> <span class="nn">myfpga.interfaz_pcps</span>   <span class="kn">import</span>  <span class="o">*</span>
<span class="kn">from</span> <span class="nn">myutils.tensor</span>         <span class="kn">import</span>  <span class="o">*</span>


<div class="viewcode-block" id="sim_romatrix">
<a class="viewcode-back" href="../../fpga.ring_osc.html#fpga.ring_osc.sim_romatrix">[docs]</a>
<span class="k">def</span> <span class="nf">sim_romatrix</span><span class="p">(</span><span class="n">N_rep</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">N_pdl</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">N_osc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">std_rep</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">std_pdl</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">std_osc</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Esta función proporciona un simulador naíf de una matriz de celdas; reproduce las medidas de una instancia para un número de repeticiones (N_rep), pdl (N_pdl) y celdas (N_osc), así como ajustar las desviaciones estándar de cada proceso. El comportamiento estándar es: std_rep&lt;std_pdl&lt;std_osc La función genera los valores aleatorios como una distribución normal, pero luego los escala para devolver siempre valores enteros positivos.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    N_rep : int, opcional</span>
<span class="sd">        Número de repeticiones simuladas.</span>
<span class="sd">    N_pdl : int, opcional</span>
<span class="sd">        Número de PDL simulados.</span>
<span class="sd">    N_osc : int, opcional</span>
<span class="sd">        Número de celdas simuladas.</span>
<span class="sd">    std_rep : float, opcional</span>
<span class="sd">        Desviación estándar de una misma celda, para un mismo PDL entre</span>
<span class="sd">        medidas sucesivas.</span>
<span class="sd">    std_pdl : float, opcional</span>
<span class="sd">        Desviación estandar de una misma celda entre distintos PDL</span>
<span class="sd">    std_osc : float, opcional</span>
<span class="sd">        Desviación estándar entre distintas celdas.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sim_osc</span> <span class="o">=</span> <span class="p">[</span><span class="n">_normal</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="n">std_osc</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_osc</span><span class="p">)]</span> <span class="c1"># rep,pdl,osc</span>
    
    <span class="n">sim_osc_pdl</span> <span class="o">=</span> <span class="p">[[</span><span class="n">sim_osc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">_normal</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="n">std_pdl</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_pdl</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_osc</span><span class="p">)]</span>
    
    <span class="n">sim_osc_pdl_rep</span> <span class="o">=</span> <span class="p">[[[</span><span class="n">sim_osc_pdl</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">_normal</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="n">std_rep</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_rep</span><span class="p">)]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_pdl</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_osc</span><span class="p">)]</span>
    
    <span class="n">sim_rep_pdl_osc</span> <span class="o">=</span> <span class="n">_transpose</span><span class="p">(</span><span class="n">sim_osc_pdl_rep</span><span class="p">)</span>
    <span class="n">sim_rep_pdl_osc</span><span class="o">-=</span><span class="nb">min</span><span class="p">(</span><span class="n">sim_rep_pdl_osc</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
    <span class="n">sim_rep_pdl_osc</span><span class="o">+=</span><span class="mf">0.5</span><span class="o">*</span><span class="nb">max</span><span class="p">(</span><span class="n">sim_rep_pdl_osc</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
    
    <span class="k">return</span> <span class="p">((</span><span class="n">sim_rep_pdl_osc</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span><span class="o">*</span><span class="mi">1000000</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> </div>

        
        
<div class="viewcode-block" id="clog2">
<a class="viewcode-back" href="../../fpga.ring_osc.html#fpga.ring_osc.clog2">[docs]</a>
<span class="k">def</span> <span class="nf">clog2</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Numero de bits necesarios para especificar &#39;N&#39; estados.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    N : int</span>
<span class="sd">        Número del cual calcular la función &#39;ceiling log&#39;</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Número entero más pequeño que es mayor o igual al resultado del logaritmo base 2 de `N`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">N</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_log2</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">&gt;</span><span class="nb">int</span><span class="p">(</span><span class="n">_log2</span><span class="p">(</span><span class="n">N</span><span class="p">)):</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">_log2</span><span class="p">(</span><span class="n">N</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">_log2</span><span class="p">(</span><span class="n">N</span><span class="p">))</span></div>

            
            
<div class="viewcode-block" id="load">
<a class="viewcode-back" href="../../fpga.ring_osc.html#fpga.ring_osc.load">[docs]</a>
<span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;&#39;Wrapper&#39; para la función &#39;load&#39; del módulo `pickle`, que permite cargar un objeto guardado serializado de cualquier clase.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file_name : str</span>
<span class="sd">        Nombre del archivo a cargar.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span></div>



<div class="viewcode-block" id="StdRing">
<a class="viewcode-back" href="../../fpga.ring_osc.html#fpga.ring_osc.StdRing">[docs]</a>
<span class="k">class</span> <span class="nc">StdRing</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Este objeto contiene una lista de elementos (LUT) que constituyen un oscilador de anillo estándar junto con la información necesaria para su implementación en FPGA utilzando el software &#39;Vivado&#39;.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        Nombre utilizado para identificar el anillo.</span>
<span class="sd">            </span>
<span class="sd">    N_inv : int</span>
<span class="sd">        Número de inversores que forman el anillo.</span>
<span class="sd">        </span>
<span class="sd">    loc : str</span>
<span class="sd">        Parámetro &#39;loc&#39; de la primera LUT del anillo (ver clase &#39;Lut&#39;). En un anillo estándar esta LUT siempre corresponde a la puerta AND inicial. Solo se da la posición de la primera LUT porque los anillos siempre se construyen ocupando todos los &#39;bel&#39; de una celda antes de pasar a la celda inmediatamente superior (de modo que, dadas las coordenadas del primer elemento, las demás están predeterminadas). La &quot;celda inmediatamente superior&quot; es X+1 si X es par, Y+1 si X es impar.</span>
<span class="sd">    </span>
<span class="sd">    bel : char o lista de char </span>
<span class="sd">        Lista de parámetros &#39;bel&#39; para cada LUT del anillo (ver clase &#39;Lut&#39;). Cada elemento de la lista se aplica en orden correlativo al elemento del anillo (la primera restricción se aplica al AND inicial, la segunda al primer inversor, etc). Pueden darse menos restricciones que inversores forman el anillo, pero entonces quedarán LUT sin fijar. Notar además que el valor de esta restricción es excluyente entre LUT que forman parte de la misma celda: cada celda tiene cuatro posibles posiciones A, B, C y D, y dos LUT no pueden ocupar el mismo espacio. Esta función no avisa de esta violación: el usuario es responsable de que los valores &#39;bel&#39; introducidos sean todos distintos entre sí en grupos de cuatro. En otro caso, el diseño fallará. Además de una lista de caracteres, esta opción admite un único caracter, pero entonces solo se restringirá la AND inicial. Ver opción &#39;bel&#39; de la clase &#39;Lut&#39;. Notar que el número de elementos total de un anillo &quot;StdRing&quot; es igual a N_inv+1, siendo el primero siempre una LUT2 (AND).</span>
<span class="sd">    </span>
<span class="sd">    pin : str o lista de str</span>
<span class="sd">        Lista de parámetros &#39;pin&#39; de cada LUT que forma parte del anillo (ver clase &#39;Lut&#39;). Cada elemento de la lista se aplica en orden correlativo al elemento del anillo (la primera restricción se aplica al AND inicial, la segunda al primer inversor, etc). Pueden darse menos restricciones que inversores forman el anillo, pero entonces quedarán LUT sin mapear. Notar que el mapeo debe ser coherente con el tipo de LUT que se está fijando, y en particular el AND inicial siempre es de tipo LUT2 (i.e., solo se pueden fijar los pines &#39;I0&#39; y &#39;I1&#39;). Notar que el número de elementos total de un anillo &quot;StdRing&quot; es igual a N_inv+1, siendo el primero siempre una LUT2 (AND). Por definición, el puerto lógico &#39;I0&#39; siempre es el que recoge la señal del elemento precedente en el bucle.</span>
<span class="sd">    </span>
<span class="sd">    pdl : bool, opcional</span>
<span class="sd">        Si &#39;True&#39; se utilizan modelos LUT6 para los inversores, permitiendo utilizar 5 puertos para configurar el anillo mediante PDL. Si &#39;False&#39; se utilizan modelos LUT1 para los inversores y LUT2 para el enable AND. Por defecto False.        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">N_inv</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">bel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">pin</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">pdl</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Nombre del anillo instanciado.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N_inv</span> <span class="o">=</span> <span class="n">N_inv</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Número de inversores del anillo.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loc</span> <span class="o">=</span> <span class="p">[</span><span class="n">loc</span><span class="p">]</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parámetro LOC de la primera puerta del anillo.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Lista de objetos Lut que conforman el anillo. El primer elemento será Lut2, y los restantes `N_inv` elementos serán Lut1 o Lut6 en función de si la opción `pdl` es &#39;True&#39;.&quot;&quot;&quot;</span>
        
        <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">x</span> <span class="c1"># Coord. x inicial</span>
        <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_inv</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">4</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>  <span class="c1"># N. luts por celda.</span>
                <span class="k">if</span> <span class="n">x</span><span class="o">%</span><span class="mi">2</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">x</span><span class="o">+=</span><span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">x0</span><span class="o">-</span><span class="n">x0</span><span class="o">%</span><span class="mi">2</span> <span class="c1"># Mantenemos la x en la misma columna</span>
                    <span class="n">y</span><span class="o">+=</span><span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">bel</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_inv</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Lista de restricciones BEL para cada elemento del anillo.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">bel</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">([]):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bel</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">bel</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">pin</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_inv</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Lista de restricciones PIN para cada elemento del anillo.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">([]):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pin</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pin</span>
            
        <span class="k">if</span> <span class="n">pdl</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elements</span> <span class="o">=</span> <span class="p">[</span><span class="n">Lut2</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AND_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;4&#39;h8&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;w_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">[0]&quot;</span><span class="p">,</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;out_romatrix[</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;enable_romatrix[</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">bel</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pin</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_inv</span><span class="p">):</span>
                <span class="n">w_in</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;w_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;sel_pdl[0]&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;sel_pdl[1]&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;sel_pdl[2]&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;sel_pdl[3]&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;sel_pdl[4]&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="n">N_inv</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">w_out</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;out_romatrix[</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">]&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">w_out</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;w_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">]&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Lut6</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;inv_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;64&#39;h5555555555555555&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">w_out</span><span class="p">,</span> <span class="n">w_in</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bel</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pin</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elements</span> <span class="o">=</span> <span class="p">[</span><span class="n">Lut2</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AND_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;4&#39;h8&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;w_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">[0]&quot;</span><span class="p">,</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;out_romatrix[</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;enable_romatrix[</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">bel</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pin</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_inv</span><span class="p">):</span>
                <span class="n">w_in</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;w_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]&quot;</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="n">N_inv</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">w_out</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;out_romatrix[</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">]&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">w_out</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;w_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">]&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Lut1</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;inv_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;2&#39;h1&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">w_out</span><span class="p">,</span> <span class="n">w_in</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bel</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pin</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
            
<div class="viewcode-block" id="StdRing.help">
<a class="viewcode-back" href="../../fpga.ring_osc.html#fpga.ring_osc.StdRing.help">[docs]</a>
    <span class="k">def</span> <span class="nf">help</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ayuda de la clase &#39;StdRing&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">help</span><span class="p">(</span><span class="s1">&#39;myfpga.ring_osc.StdRing&#39;</span><span class="p">)</span></div>
</div>

            
            
<div class="viewcode-block" id="GaloisRing">
<a class="viewcode-back" href="../../fpga.ring_osc.html#fpga.ring_osc.GaloisRing">[docs]</a>
<span class="k">class</span> <span class="nc">GaloisRing</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Lista de elementos (LUT) que constituyen un oscilador de anillo de Galois junto con la información necesaria para su implementación en FPGA utilzando el software &#39;Vivado&#39;.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        Nombre utilizado para identificar el anillo.</span>
<span class="sd">            </span>
<span class="sd">    N_inv : int</span>
<span class="sd">        Número de inversores que forman el anillo.</span>
<span class="sd">            </span>
<span class="sd">    loc : str</span>
<span class="sd">        Parámetro &#39;loc&#39; de la primera LUT del anillo (ver clase &#39;Lut&#39;). Solo se da la posición de la primera LUT porque los anillos siempre se construyen ocupando todos los &#39;bel&#39; de una celda antes de pasar a la celda inmediatamente superior (de modo que, dadas las coordenadas del primer elemento, las demás están predeterminadas). La &quot;celda inmediatamente superior&quot; es X+1 si X es par, Y+1 si X es impar.</span>
<span class="sd">        </span>
<span class="sd">    bel : char o lista de char</span>
<span class="sd">        Lista de parámetros &#39;bel&#39; para cada elemento del anillo (ver clase &#39;Lut&#39;). Cada elemento de la lista se aplica en orden correlativo al elemento del anillo (la primera restricción se aplica al primer elemento, la segunda al segundo, etc). Pueden darse menos restricciones que inversores forman el anillo, pero entonces quedarán LUT sin fijar. Notar además que el valor de esta restricción es excluyente entre LUT que forman parte de la misma celda: cada celda tiene cuatro posibles posiciones A, B, C y D, y dos LUT no pueden ocupar el mismo espacio. Esta función no avisa de esta violación: el usuario es responsable de que los valores &#39;bel&#39; introducidos sean todos distintos entre sí en grupos de cuatro. En otro caso, el diseño fallará. Además de una lista de caracteres, esta opción admite un único caracter, pero entonces solo se restringirá la primera LUT. Notar que el último elemento en un anillo &#39;GaloisRing&#39; siempre será un flip-flop, y el penúltimo elemento depende de la opción &#39;inverted_end&#39;: si &#39;True&#39;, el número de  elementos total del anillo será igual a N_inv+2, siendo el penúltimo elemento siempre una LUT1 (inversor final). Si por el contrario esta opción es &#39;False&#39; entonces el número de elementos del anillo será N_inv+1.</span>
<span class="sd">        </span>
<span class="sd">    pin : str o lista de str</span>
<span class="sd">        Lista de parámetros &#39;pin&#39; de cada LUT que forma parte del anillo (ver clase &#39;Lut&#39;). Cada elemento de la lista se aplica en orden correlativo al elemento del anillo (la primera restricción se aplica al primer elemento, la segunda al segundo, etc). Pueden darse menos restricciones que inversores forman el anillo, pero entonces quedarán LUT sin mapear. Notar que el mapeo debe ser coherente con el tipo de LUT que se está fijando, y en particular los inversores inicial y final siempre son de tipo LUT1 (i.e., solo se puede fijar el pin &#39;I0&#39;). Notar que, dado que el último elemento (N_inv+2 o N_inv+1, dependiendo de la opción &#39;inverted_end&#39;) de un anillo &#39;GaloisRing&#39; es un flip-flop, a efectos de la opción &quot;pin&quot; este se ignora (esta opción restringe solo los pines de las LUT, no del flip-flop). Por definición, el puerto lógico &#39;I0&#39; siempre es el que recoge la señal del elemento precedente en el bucle.</span>

<span class="sd">    pdl : bool, opcional</span>
<span class="sd">        Si &#39;True&#39; se utilizan modelos LUT6 para los inversores, permitiendo utilizar 5 puertos para configurar el anillo mediante PDL. Si &#39;False&#39; se utilizan modelos LUT1 para los inversores y LUT2 para el enable AND.</span>
<span class="sd">        </span>
<span class="sd">    poly : int, opcional</span>
<span class="sd">        Esta variable determina el polinomio a implementar en hardware. Si su valor es negativo (por defecto), entonces se implementa un anillo de Galois genérico configurable en tiempo de ejecución. En caso contrario, se producirá un anillo que implementa un polinomio fijo, utilizando la misma codificación que la función &#39;,edir()&#39;. Esto puede ahorrar una cierta cantidad de recursos hardware, a costa de perder flexibilidad.</span>
<span class="sd">        </span>
<span class="sd">    inverted_end : bool, opcional</span>
<span class="sd">        Si esta opción es &#39;True&#39;, se añadirá un inversor al final del anillo, lo cual según parece evita acoplos entre anillos cercanos. Notar que la presencia o no de este inversor cambia el número de elementos a efectos de las opciones &#39;bel&#39; y &#39;pin&#39;. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">N_inv</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">bel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">pin</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">pdl</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">poly</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">inverted_end</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Nombre del anillo instanciado.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N_inv</span> <span class="o">=</span> <span class="n">N_inv</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Número de inversores del anillo.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loc</span> <span class="o">=</span> <span class="p">[</span><span class="n">loc</span><span class="p">]</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parámetro LOC de la primera puerta del anillo.&quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">x</span> <span class="c1"># Coord. x inicial</span>
        <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_inv</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">4</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>  <span class="c1"># N. luts por celda.</span>
                <span class="k">if</span> <span class="n">x</span><span class="o">%</span><span class="mi">2</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">x</span><span class="o">+=</span><span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">x0</span><span class="o">-</span><span class="n">x0</span><span class="o">%</span><span class="mi">2</span> <span class="c1"># Mantenemos la x en la misma columna</span>
                    <span class="n">y</span><span class="o">+=</span><span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">bel</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_inv</span><span class="o">+</span><span class="mi">2</span><span class="p">)]</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Lista de restricciones BEL para cada elemento del anillo.&quot;&quot;&quot;</span><span class="s2">&quot;&quot;&quot;Lista de restricciones BEL para cada elemento del anillo.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">bel</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">([]):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bel</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">bel</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">pin</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_inv</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Lista de restricciones PIN para cada elemento del anillo.&quot;&quot;&quot;</span><span class="s2">&quot;&quot;&quot;Lista de restricciones PIN para cada elemento del anillo.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">([]):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pin</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pin</span>
            
        <span class="k">if</span> <span class="n">pdl</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elements</span> <span class="o">=</span> <span class="p">[]</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Lista de objetos que conforman el anillo. Esta consisitirá en N_inv objetos &#39;Lut&#39;, más un inversor en caso de que la opción `inverted_end`=True, más un flip-flop &#39;FF&#39;.&quot;&quot;&quot;</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_inv</span><span class="p">):</span>
                <span class="n">w_out</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;w_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]&quot;</span>
                
                <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">w_in</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;w_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">N_inv</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;sel_pdl[</span><span class="si">{</span><span class="mi">0</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;sel_pdl[</span><span class="si">{</span><span class="mi">1</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;sel_pdl[</span><span class="si">{</span><span class="mi">2</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Lut4</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;inv_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;16&#39;h5555&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">w_out</span><span class="p">,</span> <span class="n">w_in</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bel</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pin</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">poly</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">w_in</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;w_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;w_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">N_inv</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;sel_poly[</span><span class="si">{</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;sel_pdl[</span><span class="si">{</span><span class="mi">0</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;sel_pdl[</span><span class="si">{</span><span class="mi">1</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;sel_pdl[</span><span class="si">{</span><span class="mi">2</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Lut6</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;inv_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;64&#39;h9595959595959595&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">w_out</span><span class="p">,</span> <span class="n">w_in</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bel</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pin</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">poly</span><span class="o">%</span><span class="mi">2</span><span class="p">:</span> <span class="c1"># XNOR</span>
                            <span class="n">w_in</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;w_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;w_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">N_inv</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;sel_pdl[</span><span class="si">{</span><span class="mi">0</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;sel_pdl[</span><span class="si">{</span><span class="mi">1</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;sel_pdl[</span><span class="si">{</span><span class="mi">2</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Lut5</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;inv_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;32&#39;h99999999&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">w_out</span><span class="p">,</span> <span class="n">w_in</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bel</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pin</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                        <span class="k">else</span><span class="p">:</span> <span class="c1"># NOT</span>
                            <span class="n">w_in</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;w_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;sel_pdl[</span><span class="si">{</span><span class="mi">0</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;sel_pdl[</span><span class="si">{</span><span class="mi">1</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;sel_pdl[</span><span class="si">{</span><span class="mi">2</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Lut4</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;inv_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;16&#39;h5555&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">w_out</span><span class="p">,</span> <span class="n">w_in</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bel</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pin</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                        <span class="n">poly</span><span class="o">=</span><span class="n">poly</span><span class="o">//</span><span class="mi">2</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elements</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_inv</span><span class="p">):</span>
                <span class="n">w_out</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;w_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]&quot;</span>
                
                <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">w_in</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;w_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">N_inv</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">]&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Lut1</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;inv_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;2&#39;h1&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">w_out</span><span class="p">,</span> <span class="n">w_in</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bel</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pin</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">poly</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">w_in</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;w_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;w_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">N_inv</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;sel_poly[</span><span class="si">{</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Lut3</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;inv_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;8&#39;h95&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">w_out</span><span class="p">,</span> <span class="n">w_in</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bel</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pin</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">poly</span><span class="o">%</span><span class="mi">2</span><span class="p">:</span> <span class="c1"># XNOR</span>
                            <span class="n">w_in</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;w_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;w_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">N_inv</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Lut2</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;inv_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;4&#39;h9&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">w_out</span><span class="p">,</span> <span class="n">w_in</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bel</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pin</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                        <span class="k">else</span><span class="p">:</span> <span class="c1"># NOT</span>
                            <span class="n">w_in</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;w_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">]&quot;</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Lut1</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;inv_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;2&#39;h1&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">w_out</span><span class="p">,</span> <span class="n">w_in</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bel</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pin</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                        <span class="n">poly</span><span class="o">=</span><span class="n">poly</span><span class="o">//</span><span class="mi">2</span>
        
        <span class="k">if</span> <span class="n">inverted_end</span><span class="p">:</span>            
            <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Lut1</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invout_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;2&#39;h1&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">N_inv</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;out_ro[</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">w_out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bel</span><span class="p">[</span><span class="n">N_inv</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pin</span><span class="p">[</span><span class="n">N_inv</span><span class="p">]))</span>    
            <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">FlipFlop</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ff_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">N_inv</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;out_sampled[</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="s1">&#39;clock_s&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;out_ro[</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bel</span><span class="p">[</span><span class="n">N_inv</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">FlipFlop</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ff_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">N_inv</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;out_sampled[</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="s1">&#39;clock_s&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;w_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">N_inv</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bel</span><span class="p">[</span><span class="n">N_inv</span><span class="p">]))</span>        
        
<div class="viewcode-block" id="GaloisRing.help">
<a class="viewcode-back" href="../../fpga.ring_osc.html#fpga.ring_osc.GaloisRing.help">[docs]</a>
    <span class="k">def</span> <span class="nf">help</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ayuda de la clase &#39;GaloisRing&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">help</span><span class="p">(</span><span class="s1">&#39;myfpga.ring_osc.GaloisRing&#39;</span><span class="p">)</span></div>
</div>

        
        
<div class="viewcode-block" id="Dominio">
<a class="viewcode-back" href="../../fpga.ring_osc.html#fpga.ring_osc.Dominio">[docs]</a>
<span class="k">class</span> <span class="nc">Dominio</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Este objeto contiene las localizaciones de un conjunto de osciladores dispuestos atendiendo a diversos parámetros geométricos. Si directriz=y, estos se colocan formando una matriz rectangular, la cual crece en dirección y en incrementos de dy. Cuando se alcanza el límite y1, la matriz se incrementa una cantidad dx en la dirección x, y vuelve a la coordenada y0. Si directriz=x, el comentario anterior se aplica substituyendo x &lt;-&gt; y.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        N_osc : int, opcional</span>
<span class="sd">            Número de osciladores del dominio.</span>
<span class="sd">            </span>
<span class="sd">        x0 : int, opcional</span>
<span class="sd">            Coordenada X del primer oscilador de la matriz.</span>
<span class="sd">         </span>
<span class="sd">        x1 : int, opcional</span>
<span class="sd">            Coordenada X máxima de la matriz (no se sobrepasará).</span>
<span class="sd">            </span>
<span class="sd">        dx : int, opcional</span>
<span class="sd">            Incremento de la coordenada X. Notar que habitualmente en las FPGA de Xilinx se reservan las coordenadas X par/impar para distintos tipos de celda (&#39;0&#39; y &#39;1&#39;).</span>
<span class="sd">            </span>
<span class="sd">        y0 : int, opcional</span>
<span class="sd">            Coordenada Y del primer oscilador de la matriz.</span>
<span class="sd">            </span>
<span class="sd">        y1 : int, opcional</span>
<span class="sd">            Coordenada Y máxima de la matriz (no se sobrepasará).</span>
<span class="sd">            </span>
<span class="sd">        dy : int, opcional</span>
<span class="sd">            Incremento de la coordenada Y.</span>
<span class="sd">            </span>
<span class="sd">        directriz : char, opcional</span>
<span class="sd">            Dirección de crecimiento de la matriz (hasta llegar a la coordenada </span>
<span class="sd">            máxima). Puede ser &#39;y&#39; o &#39;x&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N_osc</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">x1</span><span class="o">=</span><span class="n">_inf</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">y0</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y1</span><span class="o">=</span><span class="n">_inf</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">directriz</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">):</span>
    
        <span class="bp">self</span><span class="o">.</span><span class="n">N_osc</span> <span class="o">=</span> <span class="n">N_osc</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Número de osciladores del anillo.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directriz</span> <span class="o">=</span> <span class="n">directriz</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dirección de crecimiento de la matriz de anillos.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="n">x0</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Coordenada &#39;X&#39; inicial.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y0</span> <span class="o">=</span> <span class="n">y0</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Coordenada &#39;Y&#39; inicial.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x1</span> <span class="o">=</span> <span class="n">x1</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Coordenada &#39;X&#39; final.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y1</span> <span class="o">=</span> <span class="n">y1</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Coordenada &#39;Y&#39; final.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">=</span> <span class="n">dx</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Incremento de la coordenada &#39;X&#39;.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dy</span> <span class="o">=</span> <span class="n">dy</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Incremento de la coordenada &#39;Y&#39;.&quot;&quot;&quot;</span>
                
        <span class="bp">self</span><span class="o">.</span><span class="n">osc_coord</span> <span class="o">=</span> <span class="p">[]</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Lista de las coordenadas de los anillos, dados en forma de par x,y.&quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N_osc</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">y</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">y1</span> <span class="ow">or</span> <span class="n">y</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dy</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x0</span>
                    <span class="n">y</span><span class="o">+=</span><span class="bp">self</span><span class="o">.</span><span class="n">dy</span>
                    
            <span class="k">if</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">x</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span> <span class="ow">or</span> <span class="n">x</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">x</span><span class="o">+=</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span>
                    <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">osc_coord</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">directriz</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="n">y</span><span class="o">+=</span><span class="bp">self</span><span class="o">.</span><span class="n">dy</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x</span><span class="o">+=</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span>
                
<div class="viewcode-block" id="Dominio.help">
<a class="viewcode-back" href="../../fpga.ring_osc.html#fpga.ring_osc.Dominio.help">[docs]</a>
    <span class="k">def</span> <span class="nf">help</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ayuda de la clase &#39;Dominio&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">help</span><span class="p">(</span><span class="s1">&#39;myfpga.ring_osc.Dominio&#39;</span><span class="p">)</span></div>
</div>

        
        
<div class="viewcode-block" id="StdMatrix">
<a class="viewcode-back" href="../../fpga.ring_osc.html#fpga.ring_osc.StdMatrix">[docs]</a>
<span class="k">class</span> <span class="nc">StdMatrix</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Objeto que contiene una matriz de osciladores de anillo estándar.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    N_inv : int</span>
<span class="sd">        Número de inversores de cada oscilador.</span>

<span class="sd">    dominios : :obj:`Dominio` o lista de `Dominio`</span>
<span class="sd">        Osciladores que forman la matriz. Se construye como una lista de objetos `Dominio`. Si solo pasamos un dominio de osciladores podemos pasar un objeto `Dominio`, en lugar de una lista.</span>
<span class="sd">        </span>
<span class="sd">    bel : char | list(char)</span>
<span class="sd">        Dado que todos los anillos de la matriz son idénticos por diseño, esta opción es la misma que la aplicada para un solo oscilador (ver `bel` en :obj:`StdRing`).</span>
<span class="sd">            </span>
<span class="sd">    pin : str | list(str)</span>
<span class="sd">        Dado que todos los anillos de la matriz son idénticos por diseño, esta opción es la misma que la aplicada para un solo oscilador (ver &#39;pin&#39; en &#39;StdRing&#39;).</span>
<span class="sd">        </span>
<span class="sd">    pdl : bool, opcional</span>
<span class="sd">        Si `True` se utilizan modelos LUT6 para los inversores, permitiendo utilizar 5 puertos para configurar el anillo mediante PDL. Si `False` se utilizan modelos :obj:Lut1 para los inversores y :obj:Lut2 para el enable AND.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N_inv</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">dominios</span><span class="o">=</span><span class="n">Dominio</span><span class="p">(),</span> <span class="n">bel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">pin</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">pdl</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dominios</span><span class="o">=</span><span class="p">[]</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Lista de :obj:Dominio de que consta la matriz.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dominios</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">([])</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">dominios</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dominios</span><span class="p">[:]</span><span class="o">=</span><span class="n">dominios</span><span class="p">[:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dominios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dominios</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">N_inv</span> <span class="o">=</span> <span class="n">N_inv</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Número de inversores de cada anillo de la matriz.&quot;&quot;&quot;</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">bel</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_inv</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Restricciones BEL de cada anillo.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">bel</span><span class="p">)</span><span class="o">==</span><span class="nb">type</span><span class="p">([]):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bel</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">bel</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pin</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_inv</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Restricciones PIN de cada anillo.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span><span class="o">==</span><span class="nb">type</span><span class="p">([]):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pin</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pin</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pdl</span> <span class="o">=</span> <span class="n">pdl</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Valor booleano que indica si los anillos de la matriz son configurables mediante PDL.&quot;&quot;&quot;</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">osc_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Lista completa de osciladores que componen la matriz.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N_osc</span><span class="o">=</span><span class="mi">0</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Número total de osciladores de la matriz.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">dominio</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dominios</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">osc_coord</span> <span class="ow">in</span> <span class="n">dominio</span><span class="o">.</span><span class="n">osc_coord</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">osc_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">StdRing</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">N_osc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_inv</span><span class="p">,</span> <span class="n">osc_coord</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdl</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">N_osc</span><span class="o">+=</span><span class="mi">1</span>
                
        <span class="bp">self</span><span class="o">.</span><span class="n">N_bits_osc</span> <span class="o">=</span> <span class="n">clog2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N_osc</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Número de bits necesarios para especificar cada oscilador.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N_bits_resol</span> <span class="o">=</span> <span class="mi">5</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Número de bits necesarios para especificar la resolución del proceso de medida.&quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdl</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">N_bits_pdl</span> <span class="o">=</span> <span class="mi">5</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Número de bits necesarios para especificar cada PDL.&quot;&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">N_bits_pdl</span> <span class="o">=</span> <span class="mi">0</span>
                
<div class="viewcode-block" id="StdMatrix.help">
<a class="viewcode-back" href="../../fpga.ring_osc.html#fpga.ring_osc.StdMatrix.help">[docs]</a>
    <span class="k">def</span> <span class="nf">help</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ayuda de la clase &#39;StdMatrix&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">help</span><span class="p">(</span><span class="s1">&#39;myfpga.ring_osc.StdMatrix&#39;</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="StdMatrix.save">
<a class="viewcode-back" href="../../fpga.ring_osc.html#fpga.ring_osc.StdMatrix.save">[docs]</a>
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &#39;Wrapper&#39; para guardar objetos serializados con el módulo &#39;pickle&#39;.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file_name : str</span>
<span class="sd">            Nombre del archivo de salida.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="StdMatrix.gen_romatrix">
<a class="viewcode-back" href="../../fpga.ring_osc.html#fpga.ring_osc.StdMatrix.gen_romatrix">[docs]</a>
    <span class="k">def</span> <span class="nf">gen_romatrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_name</span><span class="o">=</span><span class="s2">&quot;romatrix.v&quot;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Genera un diseño &#39;out_name&#39; en formato Verilog con la implementación de </span>
<span class="sd">        los dominios introducidos durante la inicialización del objeto. El </span>
<span class="sd">        principal uso de esta función es dentro de la función &#39;implement()&#39;.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        out_name : str, opcional</span>
<span class="sd">            Nombre del fichero de salida.</span>
<span class="sd">            </span>
<span class="sd">        debug : bool, opcional</span>
<span class="sd">            Flag que indica si se debe geenrar un diseño de depuración en lugar de una verdadera matriz de osciladores de anillo. En el diseño de depuración se substituye cada anillo por un divisor de reloj de frecuencia conocida, lo que permite depurar la interfaz de medida.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_name</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;//N_osciladores: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">N_osc</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;module ROMATRIX (</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    input[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">N_osc</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">:0] enable_romatrix,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdl</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    input[4:0] sel_pdl,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;    (* ALLOW_COMBINATORIAL_LOOPS = </span><span class="se">\&quot;</span><span class="s2">true</span><span class="se">\&quot;</span><span class="s2">, DONT_TOUCH = </span><span class="se">\&quot;</span><span class="s2">true</span><span class="se">\&quot;</span><span class="s2"> *)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    output[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">N_osc</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">:0] out_romatrix</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;    );</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N_osc</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    wire[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">N_inv</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">:0] w_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">debug</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">osc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">osc_list</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">lut</span> <span class="ow">in</span> <span class="n">osc</span><span class="o">.</span><span class="n">elements</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">lut</span><span class="o">.</span><span class="n">impl</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;endmodule</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N_osc</span><span class="p">):</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    CLOCK_DIVIDER cd_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> (</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;        .clock_in(clock),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .fdiv(</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .clock_out(ring</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_out)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;    );</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;endmodule</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>

                
<div class="viewcode-block" id="StdMatrix.implement">
<a class="viewcode-back" href="../../fpga.ring_osc.html#fpga.ring_osc.StdMatrix.implement">[docs]</a>
    <span class="k">def</span> <span class="nf">implement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">projname</span><span class="o">=</span><span class="s1">&#39;project_romatrix&#39;</span><span class="p">,</span> <span class="n">projdir</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">njobs</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">board</span><span class="o">=</span><span class="s1">&#39;pynqz2&#39;</span><span class="p">,</span> <span class="n">qspi</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">routing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pblock</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">data_width</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">buffer_out_width</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">f_clock</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Copia en el directorio &#39;self.projdir&#39; todos los archivos necesarios para implementar una matriz de osciladores de anillo con medición de la frecuencia y comunicación pc &lt;-&gt; microprocesador &lt;-&gt; FPGA.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        projname : str, opcional</span>
<span class="sd">            Nombre del proyecto de Vivado.</span>
<span class="sd">        </span>
<span class="sd">        projdir : str, opcional</span>
<span class="sd">            Directorio donde se creará el proyecto de Vivado y las fuentes (por defecto el directorio de trabajo actual).</span>
<span class="sd">        </span>
<span class="sd">        njobs : int, opcional</span>
<span class="sd">            Número de núcleos que utiilizará Vivado paralelamente para la síntesis/implementación.</span>
<span class="sd">            </span>
<span class="sd">        debug : bool, opcional</span>
<span class="sd">            Si &#39;True&#39;, se implementará una matriz de divisores de reloj de frecuencia conocida, lo que permite depurar el diseño al conocer qué resultados deben salir.</span>
<span class="sd">            </span>
<span class="sd">        files : bool, opcional</span>
<span class="sd">             Si &#39;True&#39;, pinta los archivos necesarios para implementar la matriz en FPGA. Esta opción se puede desactivar (False) cuando queremos configurar un objeto tipo &#39;Romatrix&#39; pero no vamos a implementarla físicamente (por ejemplo porque ya lo hemos hecho y solo queremos medir, o vamos a simularla sin realizarla).</span>
<span class="sd">            </span>
<span class="sd">        board : str, opcional</span>
<span class="sd">            Placa de desarrollo utilizada en el proyecyo. Las opciones soportadas son: &#39;pynqz2&#39;, &#39;zybo&#39;, &#39;cmoda7_15t&#39; o &#39;cmoda7_35t&#39;.</span>
<span class="sd">            </span>
<span class="sd">        qspi : bool, opcional</span>
<span class="sd">            Si &quot;True&quot;, el flujo de diseño incluirá el guardado del bitstream en la memoria flash de la placa para que se auto-programe al encenderse.</span>
<span class="sd">            </span>
<span class="sd">        routing : bool, opcional</span>
<span class="sd">            Si &quot;True&quot;, el flujo de diseño incluirá el cableado de los inversores después de la síntesis. Esto aumenta las probabilidades de que la herramienta haga un cableado idéntico, pero es recomendable comprobarlo. (NOTA: no tengo garantías de que esta opción sea del todo compatible con -qspi).</span>
<span class="sd">            </span>
<span class="sd">        pblock : bool, opcional</span>
<span class="sd">            Si esta opción es &#39;True&#39; se inserta la matriz en un pblock tal que el espacio dentro del bloque se excluye para toda lógica que no sea la propia matriz.</span>

<span class="sd">        data_width : int, opcional</span>
<span class="sd">            Esta opción especifica la anchura del canal de datos PS&lt;--&gt;PL.</span>

<span class="sd">        buffer_out_width : int, opcional</span>
<span class="sd">            Esta opción especifica la anchura de la palabra de respuesta (i.e., de la medida).</span>
<span class="sd">            </span>
<span class="sd">        f_clock : int, opcional</span>
<span class="sd">            Frecuencia del reloj del diseño (en MHz).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">projname</span> <span class="o">=</span> <span class="n">projname</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Nombre del proyecto.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">projdir</span> <span class="o">=</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">projdir</span><span class="p">),</span> <span class="n">projname</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ruta al directorio del proyecto.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">board</span> <span class="o">=</span> <span class="n">board</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Modelo de placa FPGA.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qspi</span> <span class="o">=</span> <span class="n">qspi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">routing</span> <span class="o">=</span> <span class="n">routing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pblock</span> <span class="o">=</span> <span class="n">pblock</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_width</span> <span class="o">=</span> <span class="n">data_width</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_out_width</span> <span class="o">=</span> <span class="n">buffer_out_width</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_clock</span> <span class="o">=</span> <span class="n">f_clock</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">==</span><span class="s1">&#39;cmoda7_15t&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fpga_part</span><span class="o">=</span><span class="s2">&quot;xc7a15tcpg236-1&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">board_part</span><span class="o">=</span><span class="s2">&quot;digilentinc.com:cmod_a7-15t:part0:1.1&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">memory_part</span><span class="o">=</span><span class="s2">&quot;mx25l3233&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clk_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;/clk_wiz_1/clk_out1 (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">f_clock</span><span class="si">}</span><span class="s2"> MHz)&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">==</span><span class="s1">&#39;cmoda7_35t&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fpga_part</span><span class="o">=</span><span class="s2">&quot;xc7a35tcpg236-1&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">board_part</span><span class="o">=</span><span class="s2">&quot;digilentinc.com:cmod_a7-35t:part0:1.1&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">memory_part</span><span class="o">=</span><span class="s2">&quot;mx25l3233&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clk_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;/clk_wiz_1/clk_out1 (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">f_clock</span><span class="si">}</span><span class="s2"> MHz)&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">==</span><span class="s1">&#39;zybo&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fpga_part</span><span class="o">=</span><span class="s2">&quot;xc7z010clg400-1&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">board_part</span><span class="o">=</span><span class="s2">&quot;digilentinc.com:zybo:part0:1.0&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">memory_part</span><span class="o">=</span><span class="s2">&quot;?&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clk_name</span> <span class="o">=</span><span class="sa">f</span><span class="s2">&quot;/processing_system7_0/FCLK_CLK0 (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">f_clock</span><span class="si">}</span><span class="s2"> MHz)&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">==</span><span class="s1">&#39;pynqz2&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fpga_part</span><span class="o">=</span><span class="s2">&quot;xc7z020clg400-1&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">board_part</span><span class="o">=</span><span class="s2">&quot;tul.com.tw:pynq-z2:part0:1.0&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">memory_part</span><span class="o">=</span><span class="s2">&quot;?&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clk_name</span> <span class="o">=</span><span class="sa">f</span><span class="s2">&quot;/processing_system7_0/FCLK_CLK0 (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">f_clock</span><span class="si">}</span><span class="s2"> MHz)&quot;</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_in_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_bits_osc</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">N_bits_pdl</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">N_bits_resol</span>
        
        <span class="k">if</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_in_width</span><span class="o">%</span><span class="mi">8</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">octeto_in_width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_in_width</span><span class="o">//</span><span class="mi">8</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">octeto_in_width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_in_width</span><span class="o">//</span><span class="mi">8</span><span class="o">+</span><span class="mi">1</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_out_width</span><span class="o">%</span><span class="mi">8</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">octeto_out_width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_out_width</span><span class="o">//</span><span class="mi">8</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">octeto_out_width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_out_width</span><span class="o">//</span><span class="mi">8</span><span class="o">+</span><span class="mi">1</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_in_width</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">data_width</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">words_in_width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_in_width</span><span class="o">//</span><span class="bp">self</span><span class="o">.</span><span class="n">data_width</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">words_in_width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_in_width</span><span class="o">//</span><span class="bp">self</span><span class="o">.</span><span class="n">data_width</span><span class="o">+</span><span class="mi">1</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_out_width</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">data_width</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">words_out_width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_out_width</span><span class="o">//</span><span class="bp">self</span><span class="o">.</span><span class="n">data_width</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">words_out_width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_out_width</span><span class="o">//</span><span class="bp">self</span><span class="o">.</span><span class="n">data_width</span><span class="o">+</span><span class="mi">1</span>

            <span class="n">dw_ge_biw</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">biw_aligned_dw</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">biw_misaligned_dw</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_width</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_in_width</span><span class="p">:</span>
                <span class="n">dw_ge_biw</span><span class="o">=</span><span class="s1">&#39;`define DW_GE_BIW&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_in_width</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">data_width</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">biw_aligned_dw</span><span class="o">=</span><span class="s1">&#39;`define BIW_ALIGNED_DW&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">biw_misaligned_dw</span><span class="o">=</span><span class="s1">&#39;`define BIW_MISALIGNED_DW&#39;</span>

            <span class="n">dw_ge_bow</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">bow_aligned_dw</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">bow_misaligned_dw</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_width</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_out_width</span><span class="p">:</span>
                <span class="n">dw_ge_bow</span><span class="o">=</span><span class="s1">&#39;`define DW_GE_BOW&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_out_width</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">data_width</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">bow_aligned_dw</span><span class="o">=</span><span class="s1">&#39;`define BOW_ALIGNED_DW&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bow_misaligned_dw</span><span class="o">=</span><span class="s1">&#39;`define BOW_MISALIGNED_DW&#39;</span>
                
                
            <span class="c1">## Project directory</span>
            <span class="n">_os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="p">)</span>
                
                
            <span class="c1">## Flow</span>
            <span class="n">_os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/flow&quot;</span><span class="p">)</span>
            
            <span class="c1">### Design (tcl)</span>
            <span class="n">_os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/flow/design&quot;</span><span class="p">)</span>
            
            <span class="c1">#### block design</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span> <span class="o">==</span> <span class="s2">&quot;cmoda7_15t&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">qspi</span><span class="p">:</span>
                    <span class="n">_copy</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span><span class="s1">&#39;tcl/bd_interfaz_qspi_cmoda7_15t.tcl&#39;</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/flow/design/bd_design_1.tcl&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_copy</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span><span class="s1">&#39;tcl/bd_interfaz_cmoda7_15t.tcl&#39;</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/flow/design/bd_design_1.tcl&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span> <span class="o">==</span> <span class="s2">&quot;cmoda7_35t&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">qspi</span><span class="p">:</span>
                    <span class="n">_copy</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span><span class="s1">&#39;tcl/bd_interfaz_qspi_cmoda7_35t.tcl&#39;</span><span class="p">),</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/flow/design/bd_design_1.tcl&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_copy</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span><span class="s1">&#39;tcl/bd_interfaz_cmoda7_35t.tcl&#39;</span><span class="p">),</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/flow/design/bd_design_1.tcl&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span> <span class="o">==</span> <span class="s2">&quot;zybo&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">qspi</span><span class="p">:</span>
                    <span class="n">_copy</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span><span class="s1">&#39;tcl/bd_interfaz_qspi_zybo.tcl&#39;</span><span class="p">),</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/flow/design/bd_design_1.tcl&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_copy</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span><span class="s1">&#39;tcl/bd_interfaz_zybo.tcl&#39;</span><span class="p">),</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/flow/design/bd_design_1.tcl&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span> <span class="o">==</span> <span class="s2">&quot;pynqz2&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">qspi</span><span class="p">:</span>
                    <span class="n">_copy</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span><span class="s1">&#39;tcl/bd_interfaz_qspi_pynqz2.tcl&#39;</span><span class="p">),</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/flow/design/bd_design_1.tcl&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_copy</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span><span class="s1">&#39;tcl/bd_interfaz_pynqz2.tcl&#39;</span><span class="p">),</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/flow/design/bd_design_1.tcl&quot;</span><span class="p">)</span>
            
            <span class="c1">#### build hw</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/flow/design/setupdesign.tcl&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;create_project project_vivado </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado -part </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fpga_part</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;set_property board_part </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">board_part</span><span class="si">}</span><span class="s2"> [current_project]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;source </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/flow/design/bd_design_1.tcl</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;update_compile_order -fileset sources_1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;regenerate_bd_layout</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;update_compile_order -fileset sources_1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;add_files -norecurse </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/source/vivado</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pblock</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;add_files </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/source/vivado/pblock.xdc</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;update_compile_order -fileset sources_1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;create_bd_cell -type module -reference TOP TOP_0</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;set_property -dict [list CONFIG.C_GPIO_WIDTH </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_width</span><span class="si">}</span><span class="s2"> CONFIG.C_GPIO2_WIDTH </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_width</span><span class="si">}</span><span class="s2">] [get_bd_cells axi_gpio_data]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;connect_bd_net [get_bd_pins TOP_0/data_in] [get_bd_pins axi_gpio_data/gpio2_io_o]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;connect_bd_net [get_bd_pins TOP_0/data_out] [get_bd_pins axi_gpio_data/gpio_io_i]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;connect_bd_net [get_bd_pins TOP_0/ctrl_in] [get_bd_pins axi_gpio_ctrl/gpio2_io_o]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;connect_bd_net [get_bd_pins TOP_0/ctrl_out] [get_bd_pins axi_gpio_ctrl/gpio_io_i]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;apply_bd_automation -rule xilinx.com:bd_rule:clkrst -config </span><span class="se">{{</span><span class="s2">Clk </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">clk_name</span><span class="si">}</span><span class="s2"> </span><span class="se">}}</span><span class="s2">  [get_bd_pins TOP_0/clock]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;regenerate_bd_layout</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;make_wrapper -files [get_files </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/sources_1/bd/design_1/design_1.bd] -top</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;add_files -norecurse </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/sources_1/bd/design_1/hdl/design_1_wrapper.v</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;update_compile_order -fileset sources_1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;set_property top design_1_wrapper [current_fileset]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;update_compile_order -fileset sources_1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;set_property STEPS.SYNTH_DESIGN.ARGS.RESOURCE_SHARING off [get_runs synth_1]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_clock</span><span class="o">!=</span><span class="mi">100</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">==</span><span class="s2">&quot;zybo&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">==</span><span class="s2">&quot;pynqz2&quot;</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;set_property -dict [list CONFIG.PCW_FPGA0_PERIPHERAL_FREQMHZ </span><span class="se">{{</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">f_clock</span><span class="si">}</span><span class="se">}}</span><span class="s2">] [get_bd_cells processing_system7_0]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;validate_bd_design</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;save_bd_design</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/flow/design/genbitstream.tcl&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;if </span><span class="se">{{</span><span class="s2">[file exists </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/constrs_1/new/routing.xdc]==1</span><span class="se">}}</span><span class="s2"> </span><span class="se">{{\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    export_ip_user_files -of_objects  [get_files </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/constrs_1/new/routing.xdc] -no_script -reset -force -quiet</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    remove_files  -fileset constrs_1 </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/constrs_1/new/routing.xdc</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">}}\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;if </span><span class="se">{{</span><span class="s2">[file exists </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/constrs_1/new/bitstreamconfig.xdc]==1</span><span class="se">}}</span><span class="s2"> </span><span class="se">{{\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    export_ip_user_files -of_objects  [get_files </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/constrs_1/new/bitstreamconfig.xdc] -no_script -reset -force -quiet</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    remove_files  -fileset constrs_1 </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/constrs_1/new/bitstreamconfig.xdc</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">}}\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;if </span><span class="se">{{</span><span class="s2">[file exists </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.runs/synth_1]==1</span><span class="se">}}</span><span class="s2"> </span><span class="se">{{\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    reset_run synth_1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">}}\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;update_compile_order -fileset sources_1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;update_module_reference design_1_TOP_0_0</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;launch_runs synth_1 -jobs </span><span class="si">{</span><span class="n">njobs</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;wait_on_run synth_1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">qspi</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span> <span class="o">==</span> <span class="s2">&quot;cmoda7_15t&quot;</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;file mkdir </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/constrs_1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;file mkdir </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/constrs_1/new</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;close [ open </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/constrs_1/new/bitstreamconfig.xdc w ]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;add_files -fileset constrs_1 </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/constrs_1/new/bitstreamconfig.xdc</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;set_property target_constrs_file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/constrs_1/new/bitstreamconfig.xdc [current_fileset -constrset]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;set_property used_in_synthesis false [get_files  </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/constrs_1/new/bitstreamconfig.xdc]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;update_compile_order -fileset sources_1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;update_module_reference design_1_TOP_0_0</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;open_run synth_1 -name synth_1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;set_property BITSTREAM.CONFIG.CONFIGRATE 6 [get_designs synth_1]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;set_property BITSTREAM.CONFIG.SPI_BUSWIDTH 4 [get_designs synth_1]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;set_property config_mode SPIx4 [current_design]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;save_constraints</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;close_design</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">qspi</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span> <span class="o">==</span> <span class="s2">&quot;cmoda7_35t&quot;</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;file mkdir </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/constrs_1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;file mkdir </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/constrs_1/new</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;close [ open </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/constrs_1/new/bitstreamconfig.xdc w ]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;add_files -fileset constrs_1 </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/constrs_1/new/bitstreamconfig.xdc</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;set_property target_constrs_file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/constrs_1/new/bitstreamconfig.xdc [current_fileset -constrset]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;set_property used_in_synthesis false [get_files </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/constrs_1/new/bitstreamconfig.xdc]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;update_compile_order -fileset sources_1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;update_module_reference design_1_TOP_0_0</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;open_run synth_1 -name synth_1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;set_property BITSTREAM.CONFIG.CONFIGRATE 6 [get_designs synth_1]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;set_property BITSTREAM.CONFIG.SPI_BUSWIDTH 4 [get_designs synth_1]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;set_property config_mode SPIx4 [current_design]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;save_constraints</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;close_design</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">routing</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;open_run synth_1 -name synth_1</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N_osc</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N_inv</span><span class="p">):</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;route_design -nets [get_nets design_1_i/TOP_0/inst/romatrix/w_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">]]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;set_property is_route_fixed 1 [get_nets </span><span class="se">{{</span><span class="s2">design_1_i/TOP_0/inst/romatrix/w_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">] </span><span class="se">}}</span><span class="s2">]</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;file mkdir </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/constrs_1/new</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;close [ open </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/constrs_1/new/routing.xdc w ]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;add_files -fileset constrs_1 </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/constrs_1/new/routing.xdc</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;set_property target_constrs_file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/constrs_1/new/routing.xdc [current_fileset -constrset]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;save_constraints -force</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;close_design</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;update_compile_order -fileset sources_1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;update_module_reference design_1_TOP_0_0</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># Aqui termina detailed routing</span>

                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;if </span><span class="se">{{</span><span class="s2">[file exists </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.runs/synth_1/__synthesis_is_complete__]==1</span><span class="se">}}</span><span class="s2"> </span><span class="se">{{\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    reset_run synth_1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">}}\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;launch_runs impl_1 -to_step write_bitstream -jobs </span><span class="si">{</span><span class="n">njobs</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;wait_on_run impl_1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/flow/design/exporthwd.tcl&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;file mkdir </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.sdk</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;file copy -force </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.runs/impl_1/design_1_wrapper.sysdef </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.sdk/design_1_wrapper.hdf</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/flow/design/vivado_flow.tcl&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;source </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/flow/design/setupdesign.tcl</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;source </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/flow/design/genbitstream.tcl</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;source </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/flow/design/exporthwd.tcl</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/flow/design/sdk_flow.tcl&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;setws </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.sdk</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;createhw -name design_1_wrapper_hw_platform_0 -hwspec </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.sdk/design_1_wrapper.hdf</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">==</span><span class="s2">&quot;zybo&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">==</span><span class="s2">&quot;pynqz2&quot;</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;createbsp -name app_bsp -hwproject design_1_wrapper_hw_platform_0 -proc ps7_cortexa9_0 -os standalone</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;createapp -name app -hwproject design_1_wrapper_hw_platform_0 -proc ps7_cortexa9_0 -os standalone -lang C -app {Empty Application} -bsp app_bsp</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">==</span><span class="s2">&quot;cmoda7_15t&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">==</span><span class="s2">&quot;cmoda7_35t&quot;</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;importsources -name app -path </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/source/sdk</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;build -type bsp  -name app_bsp</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;build -type app -name app</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;clean -type all</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;build -type all</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                
            <span class="n">_copy</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span><span class="s1">&#39;scripts/design_flow.py&#39;</span><span class="p">),</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/design_flow.cp.py&quot;</span><span class="p">)</span>
                
            <span class="c1">#### program FPGA</span>
            <span class="n">_os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/flow/program&quot;</span><span class="p">)</span>
            <span class="n">_copy</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span><span class="s1">&#39;tcl/program_fpga.tcl&#39;</span><span class="p">),</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/flow/program/program_fpga.cp.tcl&quot;</span><span class="p">)</span>
            <span class="n">_copy</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span><span class="s1">&#39;scripts/program_fpga.py&#39;</span><span class="p">),</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/program_fpga.cp.py&quot;</span><span class="p">)</span>
                    
            
            <span class="c1">## Source</span>
            <span class="n">_os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/source&quot;</span><span class="p">)</span>
            
            <span class="c1">### vivado</span>
            <span class="n">_os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/source/vivado&quot;</span><span class="p">)</span>
            <span class="n">_copy</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span><span class="s1">&#39;verilog/interfaz_pspl.v&#39;</span><span class="p">),</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/source/vivado/interfaz_pspl.cp.v&quot;</span><span class="p">)</span>
            <span class="n">_copy</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span><span class="s1">&#39;verilog/medidor_frec.v&#39;</span><span class="p">),</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/source/vivado/medidor_frec.cp.v&quot;</span><span class="p">)</span>
            <span class="n">_copy</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span><span class="s1">&#39;verilog/interfaz_romatrix.v&#39;</span><span class="p">),</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/source/vivado/interfaz_romatrix.cp.v&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="n">_copy</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span><span class="s1">&#39;verilog/clock_divider.v&#39;</span><span class="p">),</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/source/vivado/clock_divider.cp.v&quot;</span><span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/source/vivado/interfaz_pspl_config.vh&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dw_ge_biw</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">biw_aligned_dw</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">biw_misaligned_dw</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dw_ge_bow</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bow_aligned_dw</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bow_misaligned_dw</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">gen_romatrix</span><span class="p">(</span><span class="n">out_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/source/vivado/romatrix.v&quot;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/source/vivado/top.v&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;module TOP (</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    input           clock,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    input[7:0]      ctrl_in,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    output[7:0]     ctrl_out,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    input[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_width</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">:0]    data_in,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    output[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_width</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">:0]    data_out</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;);</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    wire[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_in_width</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">:0] buffer_in;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    wire[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_out_width</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">:0] buffer_out;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    wire sync;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    wire ack;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    wire[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">N_osc</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">:0] enable_romatrix;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    wire[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">N_osc</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">:0] out_romatrix;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    wire out_ro;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    reg enable_medidor=0;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    always @(posedge clock) begin</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        case (</span><span class="se">{{</span><span class="s2">sync,ack</span><span class="se">}}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;            2&#39;b10:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                enable_medidor &lt;= 1;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;            default:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                enable_medidor &lt;= 0;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        endcase</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    end</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    INTERFAZ_PSPL #(</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .DATA_WIDTH(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_width</span><span class="si">}</span><span class="s2">),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .BUFFER_IN_WIDTH(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_in_width</span><span class="si">}</span><span class="s2">),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .BUFFER_OUT_WIDTH(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_out_width</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    ) interfaz_pspl (</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .clock(clock),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .ctrl_in(ctrl_in),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .ctrl_out(ctrl_out),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .data_in(data_in),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .data_out(data_out),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .sync(sync),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .ack(ack),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .buffer_in(buffer_in),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .buffer_out(buffer_out)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    );</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    (* DONT_TOUCH=</span><span class="se">\&quot;</span><span class="s2">true</span><span class="se">\&quot;</span><span class="s2"> *)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    INTERFAZ_ROMATRIX #(</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .N_OSC(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">N_osc</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    ) interfaz_romatrix (</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .clock(clock),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .enable(enable_medidor),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_osc</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .sel_ro(buffer_in[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">N_bits_osc</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">:0]),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .sel_ro(1&#39;b0),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .out_romatrix(out_romatrix),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .enable_romatrix(enable_romatrix),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .out(out_ro)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    );</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    (* DONT_TOUCH=</span><span class="se">\&quot;</span><span class="s2">true</span><span class="se">\&quot;</span><span class="s2"> *)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    ROMATRIX romatrix (</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .enable_romatrix(enable_romatrix),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdl</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .sel_pdl(buffer_in[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_in_width</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">N_bits_osc</span><span class="si">}</span><span class="s2">]),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .out_romatrix(out_romatrix)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    );</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    (* DONT_TOUCH=</span><span class="se">\&quot;</span><span class="s2">true</span><span class="se">\&quot;</span><span class="s2"> *)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    MEDIDOR_FREC #(</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .OUT_WIDTH(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_out_width</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    ) medidor_frec (</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .clock(clock),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .enable(enable_medidor),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .clock_u(out_ro),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .resol(buffer_in[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_in_width</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_in_width</span><span class="o">-</span><span class="mi">5</span><span class="si">}</span><span class="s2">]),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .lock(ack),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .out(buffer_out)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    );</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;endmodule</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pblock</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/source/vivado/pblock.xdc&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">pblock_corner_xlist</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">pblock_corner_ylist</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">osc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">osc_list</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">osc_loc</span> <span class="ow">in</span> <span class="n">osc</span><span class="o">.</span><span class="n">loc</span><span class="p">:</span>
                            <span class="n">pblock_corner_xlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">osc_loc</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
                            <span class="n">pblock_corner_ylist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">osc_loc</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>
                            
                    <span class="n">PBLOCK_CORNER_0</span><span class="o">=</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">pblock_corner_xlist</span><span class="p">),</span><span class="nb">min</span><span class="p">(</span><span class="n">pblock_corner_ylist</span><span class="p">)]</span>
                    
                    <span class="n">PBLOCK_CORNER_1</span><span class="o">=</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">pblock_corner_xlist</span><span class="p">),</span><span class="nb">max</span><span class="p">(</span><span class="n">pblock_corner_ylist</span><span class="p">)]</span>
                    
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;create_pblock pblock_romatrix</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;add_cells_to_pblock [get_pblocks pblock_romatrix] [get_cells -quiet [list design_1_i/TOP_0/inst/romatrix]]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;resize_pblock [get_pblocks pblock_romatrix] -add </span><span class="se">{{</span><span class="s2">SLICE_X</span><span class="si">{</span><span class="n">PBLOCK_CORNER_0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">Y</span><span class="si">{</span><span class="n">PBLOCK_CORNER_0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">:SLICE_X</span><span class="si">{</span><span class="n">PBLOCK_CORNER_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">Y</span><span class="si">{</span><span class="n">PBLOCK_CORNER_1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="se">}}\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;set_property EXCLUDE_PLACEMENT TRUE [get_pblocks pblock_romatrix]&quot;</span><span class="p">)</span>
                    
            <span class="c1">### sdk</span>
            <span class="n">_os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/source/sdk&quot;</span><span class="p">)</span>
            <span class="n">_copy</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span><span class="s1">&#39;c-xilinx/sdk/interfaz_pcps-pspl.c&#39;</span><span class="p">),</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/source/sdk/interfaz_pcps-pspl.cp.c&quot;</span><span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/source/sdk/interfaz_pcps-pspl_config.h&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span> <span class="o">==</span> <span class="s2">&quot;cmoda7_15t&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span> <span class="o">==</span> <span class="s2">&quot;cmoda7_35t&quot;</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#include </span><span class="se">\&quot;</span><span class="s2">xuartlite.h</span><span class="se">\&quot;\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span> <span class="o">==</span> <span class="s2">&quot;zybo&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span> <span class="o">==</span> <span class="s2">&quot;pynqz2&quot;</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#include </span><span class="se">\&quot;</span><span class="s2">xuartps.h</span><span class="se">\&quot;\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;#define DATA_WIDTH          </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_width</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;#define BUFFER_IN_WIDTH     </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_in_width</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;#define BUFFER_OUT_WIDTH    </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_out_width</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;#define OCTETO_IN_WIDTH     </span><span class="si">{</span><span class="n">octeto_in_width</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;#define OCTETO_OUT_WIDTH    </span><span class="si">{</span><span class="n">octeto_out_width</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;#define WORDS_IN_WIDTH      </span><span class="si">{</span><span class="n">words_in_width</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;#define WORDS_OUT_WIDTH     </span><span class="si">{</span><span class="n">words_out_width</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                
            <span class="c1">## log info</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;N_osc       = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">N_osc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;N_bits_osc  = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">N_bits_osc</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;N_pdl       = </span><span class="si">{</span><span class="mi">2</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">N_bits_pdl</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;N_bits_pdl  = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">N_bits_pdl</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;N_bits_resol= </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">N_bits_resol</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;data_width      = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_width</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;buffer_in_width = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_in_width</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;buffer_out_width= </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_out_width</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Trama de datos:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    (0) &lt;---sel_ro(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">N_bits_osc</span><span class="si">}</span><span class="s2">)---&gt;&lt;---sel_pdl(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">N_bits_pdl</span><span class="si">}</span><span class="s2">)---&gt;&lt;---sel_resol(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">N_bits_resol</span><span class="si">}</span><span class="s2">)---&gt; (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_in_width</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;fpga part: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fpga_part</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sdk source files: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/source/sdk/&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">qspi</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;q-spi part: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">memory_part</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="StdMatrix.medir">
<a class="viewcode-back" href="../../fpga.ring_osc.html#fpga.ring_osc.StdMatrix.medir">[docs]</a>
    <span class="k">def</span> <span class="nf">medir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">puerto</span><span class="o">=</span><span class="s1">&#39;/dev/ttyS1&#39;</span><span class="p">,</span> <span class="n">osc</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pdl</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">N_rep</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">resol</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span> <span class="n">f_ref</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
              <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">baudrate</span><span class="o">=</span><span class="mi">9600</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Esta función mide la frecuencia de una matriz de osciladores estándar &#39;StdMatrix&#39;, una vez esta ha sido implementado en FPGA. El resultado se devuelve como un objeto &#39;Tensor&#39;.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        puerto : str, opcional</span>
<span class="sd">            Esta opción especifica el puerto serie al que se conecta la FPGA.</span>
<span class="sd">            </span>
<span class="sd">        osc : int | list(int), opcional</span>
<span class="sd">            Lista de osciladores a medir.</span>
<span class="sd">            </span>
<span class="sd">        pdl : int | list(int), opcional</span>
<span class="sd">            Lista de PDL a medir.</span>
<span class="sd">            </span>
<span class="sd">        N_rep : int, opcional</span>
<span class="sd">            Número de repeticiones a medir.</span>
<span class="sd">            </span>
<span class="sd">        resol : int, opcional</span>
<span class="sd">            log_2 del número de ciclos de referencia a completar para dar por terminada la medida (por defecto 17, i.e., 2^17 = 131072 ciclos).</span>
<span class="sd">            </span>
<span class="sd">        f_ref = float, opcional</span>
<span class="sd">            Frecuencia del reloj de referencia. Si se proporciona este valor, el resultado obtenido se devuelve en las mismas unidades en que se haya pasado este valor &quot;f_ref&quot;.</span>
<span class="sd">            </span>
<span class="sd">        log : bool, opcional</span>
<span class="sd">            Si se pasa &quot;True&quot; se escriben algunos datos a modo de log.</span>
<span class="sd">            </span>
<span class="sd">        verbose : bool, opcional</span>
<span class="sd">            Si se pasa &quot;True&quot; se pinta una barra de progreso de la medida. Desactivar esta opción (&quot;False&quot;) hace más cómodo utilizar esta función en un bucle.</span>
<span class="sd">            </span>
<span class="sd">        baudrate : int, opcional</span>
<span class="sd">            Tasa de transferencia del protocolo serie UART PC&lt;--&gt;PS. Debe concordar con el programa compilador en PS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">osc</span><span class="p">)</span><span class="o">==</span><span class="nb">type</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">osc_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">osc</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">osc_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">osc</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pdl</span><span class="p">)</span><span class="o">==</span><span class="nb">type</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">pdl_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">pdl</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pdl_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pdl</span><span class="p">)</span>
            
        <span class="n">N_osc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">osc_list</span><span class="p">)</span> <span class="c1"># Número de osciladores a medir</span>
        <span class="n">N_pdl</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pdl_list</span><span class="p">)</span> <span class="c1"># Número de pdl a medir</span>
        
        <span class="n">buffer_sel_ro</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">osc_list</span><span class="p">:</span>
            <span class="n">buffer_sel_ro</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resize_array</span><span class="p">(</span><span class="n">int_to_bitstr</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_bits_osc</span><span class="p">))</span>
            
        <span class="n">buffer_sel_pdl</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pdl_list</span><span class="p">:</span>
            <span class="n">buffer_sel_pdl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resize_array</span><span class="p">(</span><span class="n">int_to_bitstr</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_bits_pdl</span><span class="p">))</span>
            
        <span class="n">buffer_sel_resol</span><span class="o">=</span><span class="n">resize_array</span><span class="p">(</span><span class="n">int_to_bitstr</span><span class="p">(</span><span class="n">resol</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_bits_resol</span><span class="p">)</span>

        <span class="c1">## Info log</span>
        <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
             <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;INFO LOG:</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
            
             <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resolución             = </span><span class="si">{</span><span class="n">resol</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
             <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Número de osciladores  = </span><span class="si">{</span><span class="n">N_osc</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
             <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Número de repeticiones = </span><span class="si">{</span><span class="n">N_rep</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
             <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Número de PDL          = </span><span class="si">{</span><span class="n">N_pdl</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
             
                         
        <span class="k">with</span> <span class="n">_Serial</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="n">puerto</span><span class="p">,</span> <span class="n">baudrate</span><span class="o">=</span><span class="n">baudrate</span><span class="p">,</span> <span class="n">bytesize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="k">as</span> <span class="n">fpga</span><span class="p">:</span>
            <span class="n">_sleep</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">pinta_progreso</span> <span class="o">=</span> <span class="n">BarraProgreso</span><span class="p">(</span><span class="n">N_osc</span><span class="o">*</span><span class="n">N_rep</span><span class="o">*</span><span class="n">N_pdl</span><span class="p">)</span>
                
            <span class="n">medidas</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">rep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_rep</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">pdl</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_pdl</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">osc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_osc</span><span class="p">):</span>
                        <span class="n">buffer_in</span> <span class="o">=</span> <span class="n">buffer_sel_ro</span><span class="p">[</span><span class="n">osc</span><span class="p">]</span><span class="o">+</span><span class="n">buffer_sel_pdl</span><span class="p">[</span><span class="n">pdl</span><span class="p">]</span><span class="o">+</span><span class="n">buffer_sel_resol</span>
                        <span class="n">scan</span><span class="p">(</span><span class="n">fpga</span><span class="p">,</span> <span class="n">buffer_in</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_in_width</span><span class="p">)</span>
                        <span class="n">medida</span> <span class="o">=</span> <span class="n">bitstr_to_int</span><span class="p">(</span><span class="n">calc</span><span class="p">(</span><span class="n">fpga</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_out_width</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">f_ref</span><span class="p">:</span>
                            <span class="n">medida</span><span class="o">*=</span><span class="n">f_ref</span><span class="o">/</span><span class="mi">2</span><span class="o">**</span><span class="n">resol</span>
                        <span class="n">medidas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">medida</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="n">pinta_progreso</span><span class="p">(</span><span class="n">N_osc</span><span class="p">)</span>
        
        <span class="n">tensor_medidas</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">array</span><span class="o">=</span><span class="n">_reshape</span><span class="p">(</span><span class="n">medidas</span><span class="p">,</span> <span class="p">(</span><span class="n">N_rep</span><span class="p">,</span><span class="n">N_pdl</span><span class="p">,</span><span class="n">N_osc</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;rep&#39;</span><span class="p">,</span><span class="s1">&#39;pdl&#39;</span><span class="p">,</span><span class="s1">&#39;osc&#39;</span><span class="p">])</span>
        
        <span class="k">return</span> <span class="n">tensor_medidas</span></div>
</div>

        
        
<div class="viewcode-block" id="GaloisMatrix">
<a class="viewcode-back" href="../../fpga.ring_osc.html#fpga.ring_osc.GaloisMatrix">[docs]</a>
<span class="k">class</span> <span class="nc">GaloisMatrix</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;    </span>
<span class="sd">    Objeto que contiene una matriz de osciladores de anillo de Galois.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    N_inv : int, opcional</span>
<span class="sd">        Número de inversores de cada oscilador.</span>

<span class="sd">    dominios : :obj:`Dominio` | list(`Dominio`), opcional</span>
<span class="sd">        Osciladores que forman la matriz. Se construye como una lista de objetos &#39;Dominio&#39;. Si solo pasamos un dominio de osciladores podemos pasar un objeto &#39;Dominio&#39;, en lugar de una lista.</span>
<span class="sd">        </span>
<span class="sd">    bel : char | list(char), opcional</span>
<span class="sd">        Dado que todos los anillos de la matriz son idénticos por diseño, esta opción es la misma que la aplicada para un solo oscilador (ver &#39;bel&#39; en &#39;GaloisRing&#39;).</span>
<span class="sd">            </span>
<span class="sd">    pin : str | list(str), opcional</span>
<span class="sd">        Dado que todos los anillos de la matriz son idénticos por diseño, esta opción es la misma que la aplicada para un solo oscilador (ver &#39;pin&#39; en &#39;GaloisRing&#39;).</span>
<span class="sd">        </span>
<span class="sd">    pdl : bool, opcional</span>
<span class="sd">        Si &#39;True&#39; se utilizan modelos LUT6 para los inversores, permitiendo utilizar 5 puertos para configurar el anillo mediante PDL. Si &#39;False&#39; se utilizan modelos LUT1 para los inversores y LUT2 para el enable AND.</span>
<span class="sd">        </span>
<span class="sd">    trng: int, opcional</span>
<span class="sd">        Esta variable modifica de manera profunda el diseño de la matriz GARO implementada. Si se incluye este parámetro como un entero mayor que cero, el diseño genera un arreglo de bits generados por cada GARO como TRNG. En este caso, el buffer de salida del diseño tiene un tamaño &#39;trng&#39; dado por esta variable. Alternativamente, si no se incluye esta opción (o vale &#39;0&#39;), el diseño incluye un medidor de sesgo que devuelve el valor del sesgo de cada GARO, en lugar de producir un arreglo de bits.</span>
<span class="sd">        </span>
<span class="sd">    poly : int, opcional</span>
<span class="sd">        Esta variable determina el polinomio a implementar en hardware. Si su valor es negativo (por defecto), entonces se implementa un anillo de Galois genérico configurable en tiempo de ejecución. En caso contrario, se producirá un anillo que implementa un polinomio fijo, utilizando la misma codificación que la función &#39;,edir()&#39;. Esto puede ahorrar una cierta cantidad de recursos hardware, a costa de perder flexibilidad.</span>
<span class="sd">        </span>
<span class="sd">    inverted_end : bool, opcional</span>
<span class="sd">        Si esta opción es &#39;True&#39;, se añadirá un inversor al final del anillo, lo cual según parece evita acoplos entre anillos cercanos. Notar que la presencia o no de este inversor cambia el número de elementos a efectos de las opciones &#39;bel&#39; y &#39;pin&#39;.                </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N_inv</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">dominios</span><span class="o">=</span><span class="n">Dominio</span><span class="p">(),</span> <span class="n">bel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">pin</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">pdl</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">trng</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">poly</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">inverted_end</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dominios</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dominios</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">([])</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">dominios</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dominios</span><span class="p">[:]</span><span class="o">=</span><span class="n">dominios</span><span class="p">[:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dominios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dominios</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">N_inv</span> <span class="o">=</span> <span class="n">N_inv</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">bel</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_inv</span><span class="o">+</span><span class="mi">2</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">bel</span><span class="p">)</span><span class="o">==</span><span class="nb">type</span><span class="p">([]):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bel</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">bel</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">pin</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_inv</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span><span class="o">==</span><span class="nb">type</span><span class="p">([]):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pin</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pin</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pdl</span> <span class="o">=</span> <span class="n">pdl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trng</span> <span class="o">=</span> <span class="n">trng</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poly</span> <span class="o">=</span> <span class="n">poly</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inverted_end</span> <span class="o">=</span> <span class="n">inverted_end</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">osc_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N_osc</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">dominio</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dominios</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">osc_coord</span> <span class="ow">in</span> <span class="n">dominio</span><span class="o">.</span><span class="n">osc_coord</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">osc_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">GaloisRing</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">N_osc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_inv</span><span class="p">,</span> <span class="n">osc_coord</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">poly</span><span class="p">,</span> <span class="n">inverted_end</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">N_osc</span><span class="o">+=</span><span class="mi">1</span>
                
        <span class="bp">self</span><span class="o">.</span><span class="n">N_bits_osc</span> <span class="o">=</span> <span class="n">clog2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N_osc</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">poly</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">N_bits_poly</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_inv</span><span class="o">-</span><span class="mi">1</span> <span class="c1"># El primer inversor no se puede modificar (es una puerta NOT).</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">N_bits_poly</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># poly hardcoded.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trng</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">N_bits_resol</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">N_bits_resol</span> <span class="o">=</span> <span class="mi">5</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">N_bits_fdiv</span> <span class="o">=</span> <span class="mi">5</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdl</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">N_bits_pdl</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">N_bits_pdl</span> <span class="o">=</span> <span class="mi">0</span>
        
<div class="viewcode-block" id="GaloisMatrix.help">
<a class="viewcode-back" href="../../fpga.ring_osc.html#fpga.ring_osc.GaloisMatrix.help">[docs]</a>
    <span class="k">def</span> <span class="nf">help</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Ayuda de la clase &#39;GaloisMatrix&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">help</span><span class="p">(</span><span class="s1">&#39;myfpga.ring_osc.GaloisMatrix&#39;</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="GaloisMatrix.save">
<a class="viewcode-back" href="../../fpga.ring_osc.html#fpga.ring_osc.GaloisMatrix.save">[docs]</a>
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &#39;Wrapper&#39; para guardar objetos serializados con el módulo &#39;pickle&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="GaloisMatrix.gen_garomatrix">
<a class="viewcode-back" href="../../fpga.ring_osc.html#fpga.ring_osc.GaloisMatrix.gen_garomatrix">[docs]</a>
    <span class="k">def</span> <span class="nf">gen_garomatrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_name</span><span class="o">=</span><span class="s2">&quot;garomatrix.v&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Genera un diseño &#39;out_name&#39; en formato Verilog con la implementación de los dominios introducidos durante la inicialización del objeto. El principal uso de esta función es dentro de la función &#39;implement()&#39;.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        out_name : str, opcional</span>
<span class="sd">            Nombre del fichero de salida.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_name</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;//N_osciladores de Galois: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">N_osc</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;module GAROMATRIX (</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;    input clock,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;    input clock_s,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">poly</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    input[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">N_inv</span><span class="o">-</span><span class="mi">2</span><span class="si">}</span><span class="s2">:0] sel_poly,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_osc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    input[</span><span class="si">{</span><span class="n">clog2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N_osc</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">:0] sel_ro,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdl</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    input[2:0] sel_pdl,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>     
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;    output out</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;    );</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inverted_end</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    wire[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">N_osc</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">:0] out_ro;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    wire[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">N_osc</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">:0] out_sampled;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N_osc</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    (* ALLOW_COMBINATORIAL_LOOPS = </span><span class="se">\&quot;</span><span class="s2">true</span><span class="se">\&quot;</span><span class="s2">, DONT_TOUCH = </span><span class="se">\&quot;</span><span class="s2">true</span><span class="se">\&quot;</span><span class="s2"> *) wire[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">N_inv</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">:0] w_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_osc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;    assign out = out_sampled[sel_ro];</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;    assign out = out_sampled;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">osc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">osc_list</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">lut</span> <span class="ow">in</span> <span class="n">osc</span><span class="o">.</span><span class="n">elements</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">lut</span><span class="o">.</span><span class="n">impl</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;endmodule</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>

            
<div class="viewcode-block" id="GaloisMatrix.implement">
<a class="viewcode-back" href="../../fpga.ring_osc.html#fpga.ring_osc.GaloisMatrix.implement">[docs]</a>
    <span class="k">def</span> <span class="nf">implement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">projname</span><span class="o">=</span><span class="s2">&quot;project_garomatrix&quot;</span><span class="p">,</span> <span class="n">projdir</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">njobs</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">board</span><span class="o">=</span><span class="s1">&#39;pynqz2&#39;</span><span class="p">,</span> <span class="n">qspi</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">routing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pblock</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">data_width</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">buffer_out_width</span><span class="o">=</span><span class="mi">32</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Copia en el directorio &#39;self.projdir&#39; todos los archivos necesarios para implementar una matriz de osciladores de anillo de Galois con medición del sesgo (&quot;bias&quot;) y comunicación pc &lt;-&gt; microprocesador &lt;-&gt; FPGA.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        projname : str, opcional</span>
<span class="sd">            Nombre del proyecto de Vivado.</span>
<span class="sd">        </span>
<span class="sd">        projdir : str, opcional</span>
<span class="sd">            Directorio donde se creará el proyecto de Vivado y las fuentes (por defecto el directorio de trabajo actual).</span>
<span class="sd">        </span>
<span class="sd">        njobs : int, opcional</span>
<span class="sd">            Número de núcleos que utiilizará Vivado paralelamente para la síntesis/implementación.</span>
<span class="sd">        </span>
<span class="sd">        debug : bool, opcional</span>
<span class="sd">            Si &quot;True&quot;, se implementará una matriz de divisores de reloj de frecuencia conocida, lo que permite depurar el diseño al conocer qué resultados deben salir.</span>
<span class="sd">            </span>
<span class="sd">        files : bool, opcional</span>
<span class="sd">            Si &quot;True&quot;, pinta los archivos necesarios para implementar la matriz en FPGA. Esta opción se puede desactivar (False) cuando queremos configurar un objeto tipo &#39;Romatrix&#39; pero no vamos a implementarla físicamente (por ejemplo porque ya lo hemos hecho y solo queremos medir, o vamos a simularla sin realizarla).</span>
<span class="sd">                </span>
<span class="sd">        board : str, opcional</span>
<span class="sd">            Placa de desarrollo utilizada en el proyecyo. Las opciones soportadas son: &#39;pynqz2&#39;, &#39;zybo&#39;, &#39;cmoda7_15t&#39; o &#39;cmoda7_35t&#39;.</span>
<span class="sd">            </span>
<span class="sd">        qspi : bool, opcional</span>
<span class="sd">            Si &quot;True&quot;, el flujo de diseño incluirá el guardado del bitstream en la memoria flash de la placa para que se auto-programe al encenderse.</span>
<span class="sd">            </span>
<span class="sd">        routing : bool, opcional</span>
<span class="sd">            Si &quot;True&quot;, el flujo de diseño incluirá el cableado de los inversores después de la síntesis. Esto aumenta las probabilidades de que la herramienta haga un cableado idéntico, pero es recomendable comprobarlo. (NOTA: no tengo garantías de que esta opción sea del todo compatible con -qspi).</span>
<span class="sd">            </span>
<span class="sd">        pblock : bool, opcional</span>
<span class="sd">            Si esta opción es &#39;True&#39; se inserta la matriz en un pblock tal que el espacio dentro del bloque se excluye para toda lógica que no sea la propia matriz.</span>

<span class="sd">        data_width : int, opcional</span>
<span class="sd">            Esta opción especifica la anchura del canal de datos PS&lt;--&gt;PL.</span>

<span class="sd">        buffer_out_width : int, opcional</span>
<span class="sd">            Esta opción especifica la anchura de la palabra de respuesta (i.e., de la medida).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">projname</span> <span class="o">=</span> <span class="n">projname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">projdir</span> <span class="o">=</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">projdir</span><span class="p">),</span> <span class="n">projname</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">board</span> <span class="o">=</span> <span class="n">board</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qspi</span> <span class="o">=</span> <span class="n">qspi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">routing</span> <span class="o">=</span> <span class="n">routing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pblock</span> <span class="o">=</span> <span class="n">pblock</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_width</span> <span class="o">=</span> <span class="n">data_width</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_out_width</span> <span class="o">=</span> <span class="n">buffer_out_width</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trng</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buffer_out_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trng</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">==</span><span class="s1">&#39;cmoda7_15t&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fpga_part</span><span class="o">=</span><span class="s2">&quot;xc7a15tcpg236-1&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">board_part</span><span class="o">=</span><span class="s2">&quot;digilentinc.com:cmod_a7-15t:part0:1.1&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">memory_part</span><span class="o">=</span><span class="s2">&quot;mx25l3233&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clk_name</span><span class="o">=</span><span class="s2">&quot;/clk_wiz_1/clk_out1 (100 MHz)&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">==</span><span class="s1">&#39;cmoda7_35t&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fpga_part</span><span class="o">=</span><span class="s2">&quot;xc7a35tcpg236-1&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">board_part</span><span class="o">=</span><span class="s2">&quot;digilentinc.com:cmod_a7-35t:part0:1.1&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">memory_part</span><span class="o">=</span><span class="s2">&quot;mx25l3233&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clk_name</span><span class="o">=</span><span class="s2">&quot;/clk_wiz_1/clk_out1 (100 MHz)&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">==</span><span class="s1">&#39;zybo&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fpga_part</span><span class="o">=</span><span class="s2">&quot;xc7z010clg400-1&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">board_part</span><span class="o">=</span><span class="s2">&quot;digilentinc.com:zybo:part0:1.0&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">memory_part</span><span class="o">=</span><span class="s2">&quot;?&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clk_name</span> <span class="o">=</span> <span class="s2">&quot;/processing_system7_0/FCLK_CLK0 (100 MHz)&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">==</span><span class="s1">&#39;pynqz2&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fpga_part</span><span class="o">=</span><span class="s2">&quot;xc7z020clg400-1&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">board_part</span><span class="o">=</span><span class="s2">&quot;tul.com.tw:pynq-z2:part0:1.0&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">memory_part</span><span class="o">=</span><span class="s2">&quot;?&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clk_name</span> <span class="o">=</span> <span class="s2">&quot;/processing_system7_0/FCLK_CLK0 (100 MHz)&quot;</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_in_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_bits_osc</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">N_bits_pdl</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">N_bits_poly</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">N_bits_resol</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">N_bits_fdiv</span>
        
        <span class="k">if</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_in_width</span><span class="o">%</span><span class="mi">8</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">octeto_in_width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_in_width</span><span class="o">//</span><span class="mi">8</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">octeto_in_width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_in_width</span><span class="o">//</span><span class="mi">8</span><span class="o">+</span><span class="mi">1</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_out_width</span><span class="o">%</span><span class="mi">8</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">octeto_out_width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_out_width</span><span class="o">//</span><span class="mi">8</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">octeto_out_width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_out_width</span><span class="o">//</span><span class="mi">8</span><span class="o">+</span><span class="mi">1</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_in_width</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">data_width</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">words_in_width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_in_width</span><span class="o">//</span><span class="bp">self</span><span class="o">.</span><span class="n">data_width</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">words_in_width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_in_width</span><span class="o">//</span><span class="bp">self</span><span class="o">.</span><span class="n">data_width</span><span class="o">+</span><span class="mi">1</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_out_width</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">data_width</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">words_out_width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_out_width</span><span class="o">//</span><span class="bp">self</span><span class="o">.</span><span class="n">data_width</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">words_out_width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_out_width</span><span class="o">//</span><span class="bp">self</span><span class="o">.</span><span class="n">data_width</span><span class="o">+</span><span class="mi">1</span>

            <span class="n">dw_ge_biw</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">biw_aligned_dw</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">biw_misaligned_dw</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_width</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_in_width</span><span class="p">:</span>
                <span class="n">dw_ge_biw</span><span class="o">=</span><span class="s1">&#39;`define DW_GE_BIW&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_in_width</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">data_width</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">biw_aligned_dw</span><span class="o">=</span><span class="s1">&#39;`define BIW_ALIGNED_DW&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">biw_misaligned_dw</span><span class="o">=</span><span class="s1">&#39;`define BIW_MISALIGNED_DW&#39;</span>

            <span class="n">dw_ge_bow</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">bow_aligned_dw</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">bow_misaligned_dw</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_width</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_out_width</span><span class="p">:</span>
                <span class="n">dw_ge_bow</span><span class="o">=</span><span class="s1">&#39;`define DW_GE_BOW&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_out_width</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">data_width</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">bow_aligned_dw</span><span class="o">=</span><span class="s1">&#39;`define BOW_ALIGNED_DW&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bow_misaligned_dw</span><span class="o">=</span><span class="s1">&#39;`define BOW_MISALIGNED_DW&#39;</span>
                
                
            <span class="c1">## Project directory</span>
            <span class="n">_os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="p">)</span>
                
                
            <span class="c1">## Flow</span>
            <span class="n">_os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/flow&quot;</span><span class="p">)</span>
            
            <span class="c1">### Design (tcl)</span>
            <span class="n">_os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/flow/design&quot;</span><span class="p">)</span>
            
            <span class="c1">#### block design</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span> <span class="o">==</span> <span class="s2">&quot;cmoda7_15t&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">qspi</span><span class="p">:</span>
                    <span class="n">_copy</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span><span class="s1">&#39;tcl/bd_interfaz_qspi_cmoda7_15t.tcl&#39;</span><span class="p">),</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/flow/design/bd_design_1.tcl&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_copy</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span><span class="s1">&#39;tcl/bd_interfaz_cmoda7_15t.tcl&#39;</span><span class="p">),</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/flow/design/bd_design_1.tcl&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span> <span class="o">==</span> <span class="s2">&quot;cmoda7_35t&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">qspi</span><span class="p">:</span>
                    <span class="n">_copy</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span><span class="s1">&#39;tcl/bd_interfaz_qspi_cmoda7_35t.tcl&#39;</span><span class="p">),</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/flow/design/bd_design_1.tcl&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_copy</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span><span class="s1">&#39;tcl/bd_interfaz_cmoda7_35t.tcl&#39;</span><span class="p">),</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/flow/design/bd_design_1.tcl&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span> <span class="o">==</span> <span class="s2">&quot;zybo&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">qspi</span><span class="p">:</span>
                    <span class="n">_copy</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span><span class="s1">&#39;tcl/bd_interfaz_qspi_zybo.tcl&#39;</span><span class="p">),</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/flow/design/bd_design_1.tcl&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_copy</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span><span class="s1">&#39;tcl/bd_interfaz_zybo.tcl&#39;</span><span class="p">),</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/flow/design/bd_design_1.tcl&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span> <span class="o">==</span> <span class="s2">&quot;pynqz2&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">qspi</span><span class="p">:</span>
                    <span class="n">_copy</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span><span class="s1">&#39;tcl/bd_interfaz_qspi_pynqz2.tcl&#39;</span><span class="p">),</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/flow/design/bd_design_1.tcl&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_copy</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span><span class="s1">&#39;tcl/bd_interfaz_pynqz2.tcl&#39;</span><span class="p">),</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/flow/design/bd_design_1.tcl&quot;</span><span class="p">)</span>
                    
            <span class="c1">#### build hw</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/flow/design/setupdesign.tcl&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;create_project project_vivado </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado -part </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fpga_part</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;set_property board_part </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">board_part</span><span class="si">}</span><span class="s2"> [current_project]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;source </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/flow/design/bd_design_1.tcl</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;update_compile_order -fileset sources_1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;regenerate_bd_layout</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;update_compile_order -fileset sources_1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;add_files -norecurse </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/source/vivado</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pblock</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;add_files </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/source/vivado/pblock.xdc</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>                
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;update_compile_order -fileset sources_1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;create_bd_cell -type module -reference TOP TOP_0</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;set_property -dict [list CONFIG.C_GPIO_WIDTH </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_width</span><span class="si">}</span><span class="s2"> CONFIG.C_GPIO2_WIDTH </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_width</span><span class="si">}</span><span class="s2">] [get_bd_cells axi_gpio_data]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;connect_bd_net [get_bd_pins TOP_0/data_in] [get_bd_pins axi_gpio_data/gpio2_io_o]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;connect_bd_net [get_bd_pins TOP_0/data_out] [get_bd_pins axi_gpio_data/gpio_io_i]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;connect_bd_net [get_bd_pins TOP_0/ctrl_in] [get_bd_pins axi_gpio_ctrl/gpio2_io_o]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;connect_bd_net [get_bd_pins TOP_0/ctrl_out] [get_bd_pins axi_gpio_ctrl/gpio_io_i]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;apply_bd_automation -rule xilinx.com:bd_rule:clkrst -config </span><span class="se">{{</span><span class="s2">Clk </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">clk_name</span><span class="si">}</span><span class="s2"> </span><span class="se">}}</span><span class="s2">  [get_bd_pins TOP_0/clock]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;regenerate_bd_layout</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;validate_bd_design</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;save_bd_design</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;make_wrapper -files [get_files </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/sources_1/bd/design_1/design_1.bd] -top</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;add_files -norecurse </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/sources_1/bd/design_1/hdl/design_1_wrapper.v</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;update_compile_order -fileset sources_1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;set_property top design_1_wrapper [current_fileset]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;update_compile_order -fileset sources_1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;set_property STEPS.SYNTH_DESIGN.ARGS.RESOURCE_SHARING off [get_runs synth_1]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/flow/design/genbitstream.tcl&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;if </span><span class="se">{{</span><span class="s2">[file exists </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/constrs_1/new/routing.xdc]==1</span><span class="se">}}</span><span class="s2"> </span><span class="se">{{\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    export_ip_user_files -of_objects  [get_files </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/constrs_1/new/routing.xdc] -no_script -reset -force -quiet</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    remove_files  -fileset constrs_1 </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/constrs_1/new/routing.xdc</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">}}\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;if </span><span class="se">{{</span><span class="s2">[file exists </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/constrs_1/new/bitstreamconfig.xdc]==1</span><span class="se">}}</span><span class="s2"> </span><span class="se">{{\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    export_ip_user_files -of_objects  [get_files </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/constrs_1/new/bitstreamconfig.xdc] -no_script -reset -force -quiet</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    remove_files  -fileset constrs_1 </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/constrs_1/new/bitstreamconfig.xdc</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">}}\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;if </span><span class="se">{{</span><span class="s2">[file exists </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.runs/synth_1]==1</span><span class="se">}}</span><span class="s2"> </span><span class="se">{{\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    reset_run synth_1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">}}\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;update_compile_order -fileset sources_1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;update_module_reference design_1_TOP_0_0</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;launch_runs synth_1 -jobs </span><span class="si">{</span><span class="n">njobs</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;wait_on_run synth_1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">qspi</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span> <span class="o">==</span> <span class="s2">&quot;cmoda7_15t&quot;</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;file mkdir </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/constrs_1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;file mkdir </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/constrs_1/new</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;close [ open </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/constrs_1/new/bitstreamconfig.xdc w ]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;add_files -fileset constrs_1 </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/constrs_1/new/bitstreamconfig.xdc</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;set_property target_constrs_file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/constrs_1/new/bitstreamconfig.xdc [current_fileset -constrset]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;set_property used_in_synthesis false [get_files  </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/constrs_1/new/bitstreamconfig.xdc]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;update_compile_order -fileset sources_1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;update_module_reference design_1_TOP_0_0</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;open_run synth_1 -name synth_1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;set_property BITSTREAM.CONFIG.CONFIGRATE 6 [get_designs synth_1]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;set_property BITSTREAM.CONFIG.SPI_BUSWIDTH 4 [get_designs synth_1]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;set_property config_mode SPIx4 [current_design]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;save_constraints</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;close_design</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">qspi</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span> <span class="o">==</span> <span class="s2">&quot;cmoda7_35t&quot;</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;file mkdir </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/constrs_1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;file mkdir </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/constrs_1/new</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;close [ open </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/constrs_1/new/bitstreamconfig.xdc w ]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;add_files -fileset constrs_1 </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/constrs_1/new/bitstreamconfig.xdc</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;set_property target_constrs_file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/constrs_1/new/bitstreamconfig.xdc [current_fileset -constrset]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;set_property used_in_synthesis false [get_files </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/constrs_1/new/bitstreamconfig.xdc]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;update_compile_order -fileset sources_1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;update_module_reference design_1_TOP_0_0</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;open_run synth_1 -name synth_1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;set_property BITSTREAM.CONFIG.CONFIGRATE 6 [get_designs synth_1]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;set_property BITSTREAM.CONFIG.SPI_BUSWIDTH 4 [get_designs synth_1]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;set_property config_mode SPIx4 [current_design]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;save_constraints</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;close_design</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">routing</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;open_run synth_1 -name synth_1</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N_osc</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N_inv</span><span class="p">):</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;route_design -nets [get_nets design_1_i/TOP_0/inst/garomatrix/w_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">] ]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;set_property is_route_fixed 1 [get_nets </span><span class="se">{{</span><span class="s2">design_1_i/TOP_0/inst/garomatrix/w_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">] </span><span class="se">}}</span><span class="s2">]</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                        
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;file mkdir </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/constrs_1/new</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;close [ open </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/constrs_1/new/routing.xdc w ]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;add_files -fileset constrs_1 </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/constrs_1/new/routing.xdc</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;set_property target_constrs_file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.srcs/constrs_1/new/routing.xdc [current_fileset -constrset]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;save_constraints -force</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;close_design</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;update_compile_order -fileset sources_1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;update_module_reference design_1_TOP_0_0</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="c1"># Aqui termina detailed routing</span>
                    
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;if </span><span class="se">{{</span><span class="s2">[file exists </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.runs/synth_1/__synthesis_is_complete__]==1</span><span class="se">}}</span><span class="s2"> </span><span class="se">{{\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    reset_run synth_1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">}}\n</span><span class="s2">&quot;</span><span class="p">)</span>                    
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;launch_runs impl_1 -to_step write_bitstream -jobs </span><span class="si">{</span><span class="n">njobs</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;wait_on_run impl_1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/flow/design/exporthwd.tcl&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;file mkdir </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.sdk</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;file copy -force </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.runs/impl_1/design_1_wrapper.sysdef </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.sdk/design_1_wrapper.hdf</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/flow/design/vivado_flow.tcl&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;source </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/flow/design/setupdesign.tcl</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;source </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/flow/design/genbitstream.tcl</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;source </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/flow/design/exporthwd.tcl</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/flow/design/sdk_flow.tcl&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;setws </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.sdk</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;createhw -name design_1_wrapper_hw_platform_0 -hwspec </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/project_vivado/project_vivado.sdk/design_1_wrapper.hdf</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">==</span><span class="s2">&quot;zybo&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">==</span><span class="s2">&quot;pynqz2&quot;</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;createbsp -name app_bsp -hwproject design_1_wrapper_hw_platform_0 -proc ps7_cortexa9_0 -os standalone</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;createapp -name app -hwproject design_1_wrapper_hw_platform_0 -proc ps7_cortexa9_0 -os standalone -lang C -app {Empty Application} -bsp app_bsp</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">==</span><span class="s2">&quot;cmoda7_15t&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">==</span><span class="s2">&quot;cmoda7_35t&quot;</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;importsources -name app -path </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/source/sdk</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;build -type bsp  -name app_bsp</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;build -type app -name app</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;clean -type all</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;build -type all</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                
            <span class="n">_copy</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span><span class="s1">&#39;python/scripts/design_flow.py&#39;</span><span class="p">),</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/design_flow.cp.py&quot;</span><span class="p">)</span>
                
            <span class="c1">#### program FPGA</span>
            <span class="n">_os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/flow/program&quot;</span><span class="p">)</span>
            <span class="n">_copy</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span><span class="s1">&#39;tcl/program_fpga.tcl&#39;</span><span class="p">),</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/flow/program/program_fpga.cp.tcl&quot;</span><span class="p">)</span>
            <span class="n">_copy</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span><span class="s1">&#39;python/scripts/program_fpga.py&#39;</span><span class="p">),</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/program_fpga.cp.py&quot;</span><span class="p">)</span>
                
                
            <span class="c1">## Source</span>
            <span class="n">_os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/source&quot;</span><span class="p">)</span>
            
            <span class="c1">### vivado</span>
            <span class="n">_os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/source/vivado&quot;</span><span class="p">)</span>
            <span class="n">_copy</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span><span class="s1">&#39;verilog/interfaz_pspl.v&#39;</span><span class="p">),</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/source/vivado/interfaz_pspl.cp.v&quot;</span><span class="p">)</span>
            <span class="n">_copy</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span><span class="s1">&#39;verilog/clock_divider.v&#39;</span><span class="p">),</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/source/vivado/clock_divider.cp.v&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trng</span><span class="p">:</span>
                <span class="n">_copy</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span><span class="s1">&#39;verilog/bit_pool.v&#39;</span><span class="p">),</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/source/vivado/bit_pool.cp.v&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_copy</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span><span class="s1">&#39;verilog/medidor_bias.v&#39;</span><span class="p">),</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/source/vivado/medidor_bias.cp.v&quot;</span><span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/source/vivado/interfaz_pspl_config.vh&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dw_ge_biw</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">biw_aligned_dw</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">biw_misaligned_dw</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dw_ge_bow</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bow_aligned_dw</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bow_misaligned_dw</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">gen_garomatrix</span><span class="p">(</span><span class="n">out_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/source/vivado/garomatrix.v&quot;</span><span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/source/vivado/top.v&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;module TOP (</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    input           clock,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    input[7:0]      ctrl_in,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    output[7:0]     ctrl_out,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    input[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_width</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">:0] data_in,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    output[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_width</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">:0]    data_out</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;);</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    wire[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_in_width</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">:0] buffer_in;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    wire[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_out_width</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">:0] buffer_out;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    wire sync;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    wire ack;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    wire out_ro;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    wire clock_s;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    reg enable_medidor=0;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trng</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    wire full;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    assign ack = full;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    wire lock;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    assign ack = lock;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    always @(posedge clock) begin</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        case (</span><span class="se">{{</span><span class="s2">sync,ack</span><span class="se">}}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;            2&#39;b10:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                enable_medidor &lt;= 1;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;            default:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                enable_medidor &lt;= 0;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        endcase</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    end</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    INTERFAZ_PSPL #(</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .DATA_WIDTH(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_width</span><span class="si">}</span><span class="s2">),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .BUFFER_IN_WIDTH(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_in_width</span><span class="si">}</span><span class="s2">),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .BUFFER_OUT_WIDTH(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_out_width</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    ) interfaz_pspl (</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .clock(clock),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .ctrl_in(ctrl_in),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .ctrl_out(ctrl_out),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .data_in(data_in),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .data_out(data_out),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .sync(sync),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .ack(ack),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .buffer_in(buffer_in),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .buffer_out(buffer_out)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    );</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    CLOCK_DIVIDER clock_divider (</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .clock_in(clock),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .fdiv(buffer_in[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_in_width</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_in_width</span><span class="o">-</span><span class="mi">5</span><span class="si">}</span><span class="s2">]),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .clock_out(clock_s)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    );</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    GAROMATRIX garomatrix (</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .clock(clock),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .clock_s(clock_s),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">poly</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .sel_poly(buffer_in[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">N_bits_osc</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">N_bits_pdl</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">N_bits_poly</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">N_bits_osc</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">N_bits_pdl</span><span class="si">}</span><span class="s2">]),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_osc</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .sel_ro(buffer_in[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">N_bits_osc</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">:0]),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdl</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .sel_pdl(buffer_in[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">N_bits_osc</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">N_bits_pdl</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">N_bits_osc</span><span class="si">}</span><span class="s2">]),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .out(out_ro)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    );</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trng</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    BIT_POOL #(</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .POOL_WIDTH(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">trng</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    ) bit_pool (</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .clock(clock_s),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .enable(enable_medidor),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .muestra(out_ro),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .full(full),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .out(buffer_out[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_out_width</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">:0])</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    );</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    MEDIDOR_BIAS #(</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .OUT_WIDTH(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_out_width</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    ) medidor_bias (</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .clock(clock_s),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .enable(enable_medidor),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .muestra(out_ro),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .resol(buffer_in[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">N_bits_osc</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">N_bits_pdl</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">N_bits_poly</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">N_bits_resol</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">N_bits_osc</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">N_bits_pdl</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">N_bits_poly</span><span class="si">}</span><span class="s2">]),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .lock(lock),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        .out(buffer_out[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_out_width</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">:0])</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    );</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;endmodule</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pblock</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/source/vivado/pblock.xdc&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">pblock_corner_xlist</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">pblock_corner_ylist</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">osc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">osc_list</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">osc_loc</span> <span class="ow">in</span> <span class="n">osc</span><span class="o">.</span><span class="n">loc</span><span class="p">:</span>
                            <span class="n">pblock_corner_xlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">osc_loc</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
                            <span class="n">pblock_corner_ylist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">osc_loc</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>
                            
                    <span class="n">PBLOCK_CORNER_0</span><span class="o">=</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">pblock_corner_xlist</span><span class="p">),</span><span class="nb">min</span><span class="p">(</span><span class="n">pblock_corner_ylist</span><span class="p">)]</span>
                    
                    <span class="n">PBLOCK_CORNER_1</span><span class="o">=</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">pblock_corner_xlist</span><span class="p">),</span><span class="nb">max</span><span class="p">(</span><span class="n">pblock_corner_ylist</span><span class="p">)]</span>
                    
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;create_pblock pblock_garomatrix</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;add_cells_to_pblock [get_pblocks pblock_garomatrix] [get_cells -quiet [list design_1_i/TOP_0/inst/romatrix]]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;resize_pblock [get_pblocks pblock_garomatrix] -add </span><span class="se">{{</span><span class="s2">SLICE_X</span><span class="si">{</span><span class="n">PBLOCK_CORNER_0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">Y</span><span class="si">{</span><span class="n">PBLOCK_CORNER_0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">:SLICE_X</span><span class="si">{</span><span class="n">PBLOCK_CORNER_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">Y</span><span class="si">{</span><span class="n">PBLOCK_CORNER_1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="se">}}\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;set_property EXCLUDE_PLACEMENT TRUE [get_pblocks pblock_garomatrix]&quot;</span><span class="p">)</span>            

            <span class="c1">### sdk</span>
            <span class="n">_os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/source/sdk&quot;</span><span class="p">)</span>
            <span class="n">_copy</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span><span class="s1">&#39;c-xilinx/sdk/interfaz_pcps-pspl.c&#39;</span><span class="p">),</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/source/sdk/interfaz_pcps-pspl.cp.c&quot;</span><span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/source/sdk/interfaz_pcps-pspl_config.h&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span> <span class="o">==</span> <span class="s2">&quot;cmoda7_15t&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span> <span class="o">==</span> <span class="s2">&quot;cmoda7_35t&quot;</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#include </span><span class="se">\&quot;</span><span class="s2">xuartlite.h</span><span class="se">\&quot;\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span> <span class="o">==</span> <span class="s2">&quot;zybo&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span> <span class="o">==</span> <span class="s2">&quot;pynqz2&quot;</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#include </span><span class="se">\&quot;</span><span class="s2">xuartps.h</span><span class="se">\&quot;\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;#define DATA_WIDTH          </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_width</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;#define BUFFER_IN_WIDTH     </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_in_width</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;#define BUFFER_OUT_WIDTH    </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_out_width</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;#define OCTETO_IN_WIDTH     </span><span class="si">{</span><span class="n">octeto_in_width</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;#define OCTETO_OUT_WIDTH    </span><span class="si">{</span><span class="n">octeto_out_width</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;#define WORDS_IN_WIDTH      </span><span class="si">{</span><span class="n">words_in_width</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;#define WORDS_OUT_WIDTH     </span><span class="si">{</span><span class="n">words_out_width</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1">## log info</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;N_osc       = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">N_osc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;N_bits_osc  = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">N_bits_osc</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;N_pdl       = </span><span class="si">{</span><span class="mi">2</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">N_bits_pdl</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;N_bits_pdl  = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">N_bits_pdl</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;N_bits_poly = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">N_bits_poly</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;N_bits_resol= </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">N_bits_resol</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;N_bits_fdiv = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">N_bits_fdiv</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;data_width      = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_width</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;buffer_in_width = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_in_width</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;buffer_out_width= </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_out_width</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Trama de datos:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    (0) &lt;---sel_ro(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">N_bits_osc</span><span class="si">}</span><span class="s2">)---&gt;&lt;---sel_pdl(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">N_bits_pdl</span><span class="si">}</span><span class="s2">)---&gt;&lt;---sel_poly(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">N_bits_poly</span><span class="si">}</span><span class="s2">)---&gt;&lt;---sel_resol(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">N_bits_resol</span><span class="si">}</span><span class="s2">)---&gt;&lt;---sel_fdiv(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">N_bits_fdiv</span><span class="si">}</span><span class="s2">)---&gt; (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_in_width</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">)</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;fpga part: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fpga_part</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sdk source files: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projdir</span><span class="si">}</span><span class="s2">/source/sdk/&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">qspi</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;q-spi part: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">memory_part</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

            
<div class="viewcode-block" id="GaloisMatrix.medir">
<a class="viewcode-back" href="../../fpga.ring_osc.html#fpga.ring_osc.GaloisMatrix.medir">[docs]</a>
    <span class="k">def</span> <span class="nf">medir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">puerto</span><span class="o">=</span><span class="s1">&#39;/dev/ttyS1&#39;</span><span class="p">,</span> <span class="n">osc</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pdl</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">N_rep</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">resol</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">poly</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fdiv</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> 
              <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">baudrate</span><span class="o">=</span><span class="mi">9600</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Esta función mide la frecuencia de una matriz de osciladores de Galois &#39;GaloisMatrix&#39;, una vez esta ha sido implementado en FPGA. El resultado se devuelve como un objeto &#39;Tensor&#39;.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        puerto : str</span>
<span class="sd">            Esta opción especifica el puerto serie al que se conecta la </span>
<span class="sd">            FPGA.</span>
<span class="sd">            </span>
<span class="sd">        osc : int | list(int)</span>
<span class="sd">            Lista de osciladores a medir.</span>
<span class="sd">            </span>
<span class="sd">        pdl : int | list(int)</span>
<span class="sd">            Lista de PDL a medir.</span>
<span class="sd">            </span>
<span class="sd">        N_rep : int</span>
<span class="sd">            Número de repeticiones a medir.</span>
<span class="sd">            </span>
<span class="sd">        resol : int</span>
<span class="sd">            log_2 del número de ciclos de referencia a completar para dar por terminada la medida (por defecto 14, i.e., 2^14 = 16384 ciclos).</span>
<span class="sd">            </span>
<span class="sd">        poly : int</span>
<span class="sd">            Esta variable indica el índice del polinomio a medir.</span>
<span class="sd">            </span>
<span class="sd">        fdiv : int</span>
<span class="sd">            log_2 del factor de división menos uno, para el reloj de muestreo (por defecto 9, i.e., 2^(9+1)=1024; cin f_ref=100 MHz esto supone una frecuencia de muestre f_s=97.65 kHz).</span>
<span class="sd">            </span>
<span class="sd">        bias : bool</span>
<span class="sd">            Si se pasa esta opción como &quot;True&quot; el resultado se dará en tanto por 1.</span>
<span class="sd">            </span>
<span class="sd">        log : bool</span>
<span class="sd">            Si se pasa &quot;True&quot; se escriben algunos datos a modo de log.</span>
<span class="sd">            </span>
<span class="sd">        verbose : bool</span>
<span class="sd">            Si se pasa &quot;True&quot; se pinta una barra de progreso de la medida. Desactivar esta opción (&quot;False&quot;) hace más cómodo utilizar esta función en un bucle.</span>
<span class="sd">            </span>
<span class="sd">        baudrate : int</span>
<span class="sd">            Tasa de transferencia del protocolo serie UART PC&lt;--&gt;PS. Debe concordar con el programa compilador en PS.</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="k">def</span> <span class="nf">_print_unicode_exp</span><span class="p">(</span><span class="n">numero</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Esta función toma un número y lo escribe como un exponente utilizando caracteres UNICODE.</span>
<span class="sd">            </span>
<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            numero : int</span>
<span class="sd">                Valor a escribir como exponente.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">super_unicode</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="se">\u2070</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\u00B9</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\u00B2</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\u00B3</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\u2074</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\u2075</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\u2076</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\u2077</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\u2078</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\u2079</span><span class="s2">&quot;</span><span class="p">]</span>
            <span class="n">result</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
            <span class="n">aux</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">while</span> <span class="n">numero</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">aux</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numero</span><span class="o">%</span><span class="mi">10</span><span class="p">)</span>
                <span class="n">numero</span><span class="o">//=</span><span class="mi">10</span>
            <span class="n">aux</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="n">result</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">aux</span><span class="p">:</span>
                <span class="n">result</span><span class="o">+=</span><span class="n">super_unicode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">def</span> <span class="nf">_poly_nomenclature</span><span class="p">(</span><span class="n">entrada</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Esta función toma un array &#39;poly&#39; tal y como se utilizando en este script para representar un polinomio de Galois, y lo escribe en forma de polinomio tal y como se escribe en el paper de Golic.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">N</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">entrada</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">result</span><span class="o">=</span><span class="s2">&quot;1&quot;</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">entrada</span><span class="p">[</span><span class="o">-</span><span class="n">i</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">result</span><span class="o">+=</span><span class="s2">&quot;+x&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">result</span><span class="o">+=</span><span class="sa">f</span><span class="s2">&quot;+x</span><span class="si">{</span><span class="n">_print_unicode_exp</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">N</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">result</span><span class="o">+=</span><span class="s2">&quot;+x&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="o">+=</span><span class="sa">f</span><span class="s2">&quot;+x</span><span class="si">{</span><span class="n">_print_unicode_exp</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">osc</span><span class="p">)</span><span class="o">==</span><span class="nb">type</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">osc_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">osc</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">osc_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">osc</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pdl</span><span class="p">)</span><span class="o">==</span><span class="nb">type</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">pdl_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">pdl</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pdl_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pdl</span><span class="p">)</span>
                
        <span class="n">N_osc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">osc_list</span><span class="p">)</span> <span class="c1"># Número de osciladores</span>
        <span class="n">N_pdl</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pdl_list</span><span class="p">)</span> <span class="c1"># Número de pdl_list</span>
        
        <span class="n">buffer_sel_ro</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">osc_list</span><span class="p">:</span>
            <span class="n">buffer_sel_ro</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resize_array</span><span class="p">(</span><span class="n">int_to_bitstr</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_bits_osc</span><span class="p">))</span>
            
        <span class="n">buffer_sel_pdl</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pdl_list</span><span class="p">:</span>
            <span class="n">buffer_sel_pdl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resize_array</span><span class="p">(</span><span class="n">int_to_bitstr</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_bits_pdl</span><span class="p">))</span>
            
        <span class="n">buffer_sel_resol</span><span class="o">=</span><span class="n">resize_array</span><span class="p">(</span><span class="n">int_to_bitstr</span><span class="p">(</span><span class="n">resol</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_bits_resol</span><span class="p">)</span>
        
        <span class="n">buffer_sel_poly</span><span class="o">=</span><span class="n">resize_array</span><span class="p">(</span><span class="n">int_to_bitstr</span><span class="p">(</span><span class="n">poly</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_bits_poly</span><span class="p">)</span>
        
        <span class="n">buffer_sel_fdiv</span><span class="o">=</span><span class="n">resize_array</span><span class="p">(</span><span class="n">int_to_bitstr</span><span class="p">(</span><span class="n">fdiv</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_bits_fdiv</span><span class="p">)</span>

        <span class="c1">## Info log</span>
        <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;INFO LOG:</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">trng</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resolución             = </span><span class="si">{</span><span class="mi">2</span><span class="o">**</span><span class="n">resol</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">poly</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Polinomio              = </span><span class="si">{</span><span class="n">poly</span><span class="si">}</span><span class="s2"> --&gt; </span><span class="si">{</span><span class="n">_poly_nomenclature</span><span class="p">(</span><span class="n">buffer_sel_poly</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Polinomio (hardcoded)  = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">poly</span><span class="si">}</span><span class="s2"> --&gt; </span><span class="si">{</span><span class="n">_poly_nomenclature</span><span class="p">(</span><span class="n">resize_array</span><span class="p">(</span><span class="n">int_to_bitstr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">poly</span><span class="p">),</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">N_inv</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Frecuencia de muestreo = </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="mi">100000</span><span class="o">/</span><span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">fdiv</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> kHz</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Número de osciladores  = </span><span class="si">{</span><span class="n">N_osc</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Número de repeticiones = </span><span class="si">{</span><span class="n">N_rep</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Número de pdl_list     = </span><span class="si">{</span><span class="n">N_pdl</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            
        <span class="n">fpga</span> <span class="o">=</span> <span class="n">_Serial</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="n">puerto</span><span class="p">,</span> <span class="n">baudrate</span><span class="o">=</span><span class="n">baudrate</span><span class="p">,</span> <span class="n">bytesize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
        <span class="n">_sleep</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">pinta_progreso</span> <span class="o">=</span> <span class="n">BarraProgreso</span><span class="p">(</span><span class="n">N_osc</span><span class="o">*</span><span class="n">N_rep</span><span class="o">*</span><span class="n">N_pdl</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trng</span><span class="p">:</span>
            <span class="n">medidas_trng</span><span class="o">=</span><span class="p">[[[]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_pdl</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_rep</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">medidas_sesgo</span><span class="o">=</span><span class="p">[]</span>
            
        <span class="k">for</span> <span class="n">rep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_rep</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">pdl</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_pdl</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">osc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_osc</span><span class="p">):</span>
                    <span class="n">buffer_in</span> <span class="o">=</span> <span class="n">buffer_sel_ro</span><span class="p">[</span><span class="n">osc</span><span class="p">]</span><span class="o">+</span><span class="n">buffer_sel_pdl</span><span class="p">[</span><span class="n">pdl</span><span class="p">]</span><span class="o">+</span><span class="n">buffer_sel_poly</span><span class="o">+</span><span class="n">buffer_sel_resol</span><span class="o">+</span><span class="n">buffer_sel_fdiv</span>
                    <span class="n">scan</span><span class="p">(</span><span class="n">fpga</span><span class="p">,</span> <span class="n">buffer_in</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_in_width</span><span class="p">)</span>
                    <span class="n">medida</span> <span class="o">=</span> <span class="n">calc</span><span class="p">(</span><span class="n">fpga</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_out_width</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trng</span><span class="p">:</span>
                        <span class="n">medida_trng</span> <span class="o">=</span> <span class="n">medida</span><span class="p">[:]</span>
                        <span class="n">medidas_trng</span><span class="p">[</span><span class="n">rep</span><span class="p">][</span><span class="n">pdl</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">medida_trng</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">medida_sesgo</span> <span class="o">=</span> <span class="n">bitstr_to_int</span><span class="p">(</span><span class="n">medida</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">bias</span><span class="p">:</span>
                            <span class="n">medida_sesgo</span><span class="o">/=</span><span class="mi">2</span><span class="o">**</span><span class="n">resol</span>
                        <span class="n">medidas_sesgo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">medida_sesgo</span><span class="p">)</span>
                        
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">pinta_progreso</span><span class="p">(</span><span class="n">N_osc</span><span class="p">)</span>
        <span class="n">fpga</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trng</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">medidas_trng</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">array</span><span class="o">=</span><span class="n">_reshape</span><span class="p">(</span><span class="n">medidas_sesgo</span><span class="p">,</span> <span class="p">(</span><span class="n">N_rep</span><span class="p">,</span><span class="n">N_pdl</span><span class="p">,</span><span class="n">N_osc</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;rep&#39;</span><span class="p">,</span><span class="s1">&#39;pdl&#39;</span><span class="p">,</span><span class="s1">&#39;osc&#39;</span><span class="p">])</span></div>
</div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">thesis  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../fpga.html" >fpga</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">fpga.ring_osc</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2024, gds.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    </div>
  </body>
</html>